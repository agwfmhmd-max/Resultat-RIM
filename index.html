<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª PWA -->
    <meta name="theme-color" content="#00695c">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Resultat Rim">

    <title>Resultat Rim | Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙˆØ·Ù†ÙŠØ©</title>
    
    <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary: #00695c;
            --secondary: #004d40;
            --gold: #ffc107;
            --whatsapp: #25D366;
            --bg: #f0f2f5;
            --card: #ffffff;
            --radius: 16px;
        }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); padding-bottom: 50px; overflow-x: hidden; }
        
        .navbar { background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); color: white; }
        .container-app { max-width: 600px; margin: auto; padding: 15px; }
        .search-card { background: var(--card); border-radius: var(--radius); padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .section-title { font-weight: 700; color: var(--primary); font-size: 16px; margin-bottom: 8px; margin-top: 15px; }
        .form-control, .form-select { border-radius: 12px; padding: 12px; border: 1px solid #ddd; background: #f8f9fa; }
        .form-control:focus { box-shadow: none; border-color: var(--primary); }
        
        .btn-main { background: var(--primary); color: white; border: none; border-radius: 12px; padding: 12px; font-weight: bold; width: 100%; margin-bottom: 10px; }
        .btn-main:hover { background: var(--secondary); color: white; }
        .btn-gold { background: var(--gold); color: #000; border: none; border-radius: 12px; padding: 12px; font-weight: bold; width: 100%; }
        .btn-outline { border: 2px solid var(--primary); color: var(--primary); background: white; border-radius: 12px; padding: 10px; font-weight: bold; width: 100%; transition: 0.3s; }
        .btn-outline:hover { background: var(--primary); color: white; }
        
        .school-link { text-decoration: underline; cursor: pointer; font-weight: 700; transition: opacity 0.2s; }
        .school-link:hover { opacity: 0.8; }
        
        .number-link { text-decoration: underline; cursor: pointer; transition: opacity 0.2s; color: inherit; }
        .number-link:hover { opacity: 0.7; color: var(--primary); }

        .result-card-wrapper { margin-bottom: 20px; }
        .result-card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; animation: fadeIn 0.3s; color: #333; }

        .card-admis { background: linear-gradient(135deg, #198754, #20c997); color: white !important; }
        .card-session { background: linear-gradient(135deg, #ffc107, #fd7e14); color: white !important; }
        .card-recale { background: linear-gradient(135deg, #dc3545, #b02a37); color: white !important; }

        .card-admis .text-muted, .card-session .text-muted, .card-recale .text-muted { color: rgba(255, 255, 255, 0.85) !important; }
        .card-admis .text-success, .card-session .text-success, .card-recale .text-success { color: #fff !important; }
        .card-admis .school-link, .card-session .school-link, .card-recale .school-link { color: #fff !important; }
        .card-admis .number-link, .card-session .number-link, .card-recale .number-link { color: #fff !important; }
        
        .card-admis .info-grid, .card-session .info-grid, .card-recale .info-grid { background-color: rgba(255, 255, 255, 0.15); border-color: rgba(255, 255, 255, 0.2); }
        .card-admis .info-label, .card-session .info-label, .card-recale .info-label { color: rgba(255, 255, 255, 0.9); }
        .card-admis .info-value, .card-session .info-value, .card-recale .info-value { color: #fff; }
        .card-admis .badge, .card-session .badge, .card-recale .badge { background-color: rgba(255, 255, 255, 0.2) !important; color: #fff !important; border: 1px solid rgba(255, 255, 255, 0.3) !important; }

        .rank-badge { position: absolute; top: 10px; left: 10px; background: var(--gold); color: #000; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 2; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; background-color: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.85rem; border: 1px solid #eee; }
        .info-item { display: flex; flex-direction: column; }
        .info-label { font-weight: bold; color: var(--primary); font-size: 0.75rem; }
        .info-value { color: #333; font-weight: 600; }

        #topPageOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; overflow-y: auto; padding-bottom: 50px; display: none; }
        .top-header { background: white; padding: 15px; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }

        .selection-btn { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 10px; margin-bottom: 10px; text-align: center; font-weight: bold; color: #333; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: space-between; }
        .selection-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        
        #installBtn { display: none; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; transition: 0.3s; margin-right: auto; }
        #installBtn:hover { background: rgba(255,255,255,0.4); }

        .btn-share { background: #3b5998; color: white; border: none; border-radius: 20px; padding: 8px 15px; font-size: 0.85rem; font-weight: bold; display: flex; align-items: center; justify-content: center; width: 100%; margin-top: 10px; transition: 0.3s; }
        .btn-share:hover { background: #2d4373; color: white; }

        .whatsapp-card { background: #e7fceb; border: 1px solid #25D366; border-radius: 12px; padding: 12px; margin-top: 10px; cursor: pointer; transition: transform 0.2s; animation: fadeIn 0.5s; text-decoration: none; display: block; }
        .icon-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-left: 12px; flex-shrink: 0; color: white; }
        .icon-whatsapp { background: #25D366; }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ */
        .countdown-card { background: linear-gradient(135deg, #2c3e50, #4ca1af); color: white; border-radius: var(--radius); padding: 20px; margin-top: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .timer-box { background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px; min-width: 65px; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); }
        .timer-number { font-size: 1.5rem; font-weight: 800; display: block; line-height: 1.2; }
        .timer-label { font-size: 0.75rem; opacity: 0.9; }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
        .stats-section-title { font-weight: 800; color: var(--secondary); margin: 25px 0 10px 0; border-right: 4px solid var(--gold); padding-right: 10px; font-size: 1.1rem; background: #f8f9fa; padding: 8px 10px 8px 0; border-radius: 8px; }
        
        .stat-box { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .stat-rank { width: 30px; height: 30px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #555; flex-shrink: 0; margin-left: 10px; }
        .rank-1 { background: #ffd700; color: #000; box-shadow: 0 2px 5px rgba(255, 215, 0, 0.4); }
        .rank-2 { background: #c0c0c0; color: #000; }
        .rank-3 { background: #cd7f32; color: white; }
        
        .stat-name { font-weight: bold; font-size: 0.95rem; color: #333; }
        .stat-rate { font-weight: 800; color: var(--primary); font-size: 1rem; }
        .stat-meta { font-size: 0.75rem; color: #777; }

        .stat-grid-compact { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .stat-mini-card { background: white; padding: 10px; border-radius: 8px; border: 1px solid #eee; text-align: center; }
        
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„ */
        #simulatorOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 2000; overflow-y: auto; display: none; padding-bottom: 50px; }
        .sim-header { background: white; padding: 15px; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .subject-row { background: white; border-radius: 12px; padding: 12px; margin-bottom: 10px; border: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; }
        .coeff-badge { background: #e9ecef; color: #555; padding: 4px 10px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; margin-right: 10px; }
        .grade-input { width: 70px; text-align: center; font-weight: bold; border: 2px solid #ddd; border-radius: 8px; padding: 5px; color: var(--primary); }
        .grade-input:focus { border-color: var(--primary); outline: none; }
        .total-card { background: linear-gradient(135deg, var(--secondary), var(--primary)); color: white; border-radius: 15px; padding: 20px; margin-top: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .final-score { font-size: 2.5rem; font-weight: 800; color: var(--gold); }

        /* Ø§Ù„Ø§Ø­ØªÙØ§Ù„ */
        #celebrationOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; overflow: hidden; }
        .congrats-box { background: white; padding: 30px; border-radius: 20px; text-align: center; position: relative; z-index: 10000; animation: zoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); max-width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .congrats-title { font-size: 2rem; color: var(--primary); font-weight: 800; margin-bottom: 10px; }
        .congrats-text { font-size: 1.1rem; color: #555; margin-bottom: 20px; }
        .confetti-piece { position: absolute; font-size: 20px; top: -20px; animation: fall linear forwards; z-index: 9998; }

        @keyframes zoomIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fall { to { transform: translateY(105vh) rotate(720deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Footer Styles --- */
        footer { background: #fff; padding: 20px 0; margin-top: 40px; border-top: 1px solid #eaeaea; }
        .dev-credit { font-size: 0.9rem; color: #6c757d; }
        .dev-name { color: var(--primary); font-weight: 700; text-decoration: none; transition: color 0.2s; }
        .dev-name:hover { color: var(--secondary); }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="container-app w-100 d-flex align-items-center justify-content-between">
            <span class="navbar-brand m-0 fw-bold fs-4"><i class="fas fa-graduation-cap me-2"></i>Resultat RIM</span>
            <button id="installBtn"><i class="fas fa-download me-1"></i> ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
        </div>
    </nav>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø­ØªÙØ§Ù„ -->
    <div id="celebrationOverlay">
        <div class="congrats-box">
            <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ‰ğŸŒºğŸ¥°</div>
            <div class="congrats-title">Ø£Ù„Ù Ø£Ù„Ù Ù…Ø¨Ø±ÙˆÙƒ!</div>
            <div class="congrats-text">
                ØªÙ‡Ø§Ù†ÙŠÙ†Ø§ Ø§Ù„Ø­Ø§Ø±Ø© Ø¨Ù…Ù†Ø§Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ ÙˆØªØ¬Ø§ÙˆØ² Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ø¬Ø¯Ø§Ø±Ø©.<br>
                Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ Ù…Ø³ÙŠØ±Ø© Ø¯Ø±Ø§Ø³ÙŠØ© Ù…Ù„ÙŠØ¦Ø© Ø¨Ø§Ù„ØªÙÙˆÙ‚.
            </div>
            <button class="btn btn-main" onclick="closeCelebration()">Ø´ÙƒØ±Ø§Ù‹ â¤ï¸</button>
        </div>
    </div>

    <div class="container-app">
        <!-- Ø¹Ø¯Ø§Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ -->
        <div class="countdown-card mb-3">
            <h6 class="mb-3 fw-bold"><i class="fas fa-hourglass-half me-2"></i>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h6>
            <select id="examDateSelect" class="form-select form-select-sm mb-3 text-center" style="background: rgba(255,255,255,0.9); border:none; color:#333; font-weight:bold;">
                <option value="2026-06-22T08:00:00">Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (22 ÙŠÙˆÙ†ÙŠÙˆ)</option>
                <option value="2026-06-24T08:00:00">Ø´Ù‡Ø§Ø¯Ø© Ø®ØªÙ… Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ© (24 ÙŠÙˆÙ†ÙŠÙˆ)</option>
                <option value="2026-06-29T08:00:00" selected>Ø§Ù„Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ - Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© (29 ÙŠÙˆÙ†ÙŠÙˆ)</option>
            </select>
            <div id="countdownDisplay" class="d-flex justify-content-center gap-2" dir="ltr"></div>
        </div>

        <div class="search-card">
            <h5 class="text-center fw-bold text-secondary mb-3">Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h5>
            
            <label class="section-title">Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©:</label>
            <select id="examType" class="form-select">
                <option value="concours" selected>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (ÙƒÙˆÙ†ÙƒÙˆØ±)</option>
                <option value="brevet">Ø®ØªÙ… Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ© (Ø¨Ø±ÙŠÙØ©)</option>
                <option value="bac_n">Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ - Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©</option>
                <option value="bac_c">Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ - Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„ØªÙƒÙ…ÙŠÙ„ÙŠØ©</option>
            </select>

            <label class="section-title">Ø§Ù„Ø¨Ø­Ø« Ø¨ÙˆØ§Ø³Ø·Ø©:</label>
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <select id="searchCategory" class="form-select">
                        <option value="number">Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ±Ø´Ø­</option>
                        <option value="school">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</option>
                    </select>
                </div>
                <div class="col-6">
                    <input id="searchInput" type="text" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§...">
                </div>
            </div>

            <button id="searchBtn" class="btn-main"><i class="fas fa-search me-2"></i>Ø¨Ø­Ø«</button>
            <button onclick="openTopPage()" class="btn-gold"><i class="fas fa-chart-bar me-2"></i>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ø£ÙˆØ§Ø¦Ù„</button>
            <button onclick="openSimulator()" class="btn-outline mt-2"><i class="fas fa-calculator me-2"></i>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„ (Simulateur)</button>
        </div>

        <div id="loading" class="text-center d-none mt-4">
            <div class="spinner-border text-success"></div>
            <p class="mt-2 text-muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>

        <div id="resultsContainer" class="mt-4"></div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„ -->
    <div id="simulatorOverlay">
        <div class="sim-header">
            <h5 class="m-0 fw-bold text-success"><i class="fas fa-calculator me-2"></i>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„</h5>
            <button onclick="closeSimulator()" class="btn btn-sm btn-secondary"><i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
        <div class="container-app pt-3">
            <label class="section-title">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©:</label>
            <select id="simType" class="form-select mb-3" onchange="renderSimulatorInputs()">
                <option value="brevet">Ø®ØªÙ… Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ© (Brevet)</option>
                <option value="bac_sn">Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ - Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ© (SN)</option>
                <option value="bac_m">Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ - Ø±ÙŠØ§Ø¶ÙŠØ§Øª (M)</option>
                <option value="bac_lm">Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ - Ø¢Ø¯Ø§Ø¨ Ø¹ØµØ±ÙŠØ© (LM)</option>
                <option value="bac_lo">Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ - Ø¢Ø¯Ø§Ø¨ Ø£ØµÙ„ÙŠØ© (LO)</option>
                <option value="bac_tm">Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ - ØªÙ‚Ù†ÙŠØ© (TM)</option>
            </select>
            <div id="simInputsContainer"></div>
            <div class="total-card">
                <div class="small opacity-75">Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ</div>
                <div id="simResult" class="final-score">00.00</div>
                <div class="d-flex justify-content-center gap-3 mt-2 small">
                    <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <b id="simTotalPoints">0</b></span>
                    <span>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¶ÙˆØ§Ø±Ø¨: <b id="simTotalCoef">0</b></span>
                </div>
            </div>
            <div class="alert alert-info small mt-3"><i class="fas fa-info-circle me-1"></i> Ø§Ù„Ø­Ø³Ø§Ø¨ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¶ÙˆØ§Ø±Ø¨ Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù„Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„ÙˆØ·Ù†ÙŠØ©.</div>
        </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div id="topPageOverlay">
        <div class="top-header">
            <div class="d-flex align-items-center">
                <button id="backBtn" onclick="resetTopView()" class="btn btn-sm btn-outline-secondary me-2 d-none"><i class="fas fa-arrow-right"></i></button>
                <h5 class="m-0 fw-bold text-success"><i class="fas fa-crown me-2"></i>Ù„ÙˆØ­Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</h5>
            </div>
            <button onclick="closeTopPage()" class="btn btn-sm btn-secondary"><i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
        
        <div class="container-app">
            <div id="topMenu">
                <div class="alert alert-info small mb-3"><i class="fas fa-info-circle me-1"></i> Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù…ØªÙÙˆÙ‚ÙŠÙ†.</div>
                <button class="btn-main" onclick="loadNationalTop()"><i class="fas fa-globe-africa me-2"></i>Ø§Ù„Ù€ 20 Ø§Ù„Ø£ÙˆØ§Ø¦Ù„ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø§Ù…</button>
                <div class="row g-2 mt-2">
                    <div class="col-6" id="stateBtnCol">
                        <button class="btn-outline" onclick="renderGroupList('wilaya')"><i class="fas fa-map-marker-alt me-1"></i> Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</button>
                    </div>
                    <div class="col-6" id="majorBtnCol">
                        <button class="btn-outline" onclick="renderGroupList('major')"><i class="fas fa-book me-1"></i> Ø­Ø³Ø¨ Ø§Ù„Ø´Ø¹Ø¨Ø©</button>
                    </div>
                </div>
            </div>

            <div id="selectionListContainer" class="mt-4 d-none">
                <h6 id="selectionTitle" class="fw-bold text-secondary mb-3"></h6>
                <div id="selectionItems" class="row g-2"></div>
            </div>

            <div id="statsContainer" class="d-none"></div>
            <div id="topPageResults" class="mt-4"></div>
        </div>
    </div>

    <!-- Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø§Ù„Ø£ØµÙ„ÙŠ -->
    <footer class="text-center">
        <div class="container">
            <p class="dev-credit mb-1">Designed & Developed by</p>
            <a href="#" class="dev-name mb-2 d-block">Mohamed Dah Agove</a>
            <div style="font-size: 0.75rem; color: #999;">&copy; 2026 Resultat RIM. All rights reserved.</div>
        </div>
    </footer>

    <script>
        // PWA Setup
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log(err));
            });
        }

        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'block';
        });
        installBtn.addEventListener('click', () => {
            installBtn.style.display = 'none';
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => { deferredPrompt = null; });
            }
        });

        const orientationGroupLink = "https://www.unem2000.com/whatsapp"; 

        // Countdown Logic
        function startCountdown() {
            const select = document.getElementById('examDateSelect');
            const display = document.getElementById('countdownDisplay');
            function update() {
                const now = new Date().getTime();
                const target = new Date(select.value).getTime();
                const diff = target - now;
                if (diff < 0) { display.innerHTML = '<div class="badge bg-danger fs-6 p-2">Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø£Ùˆ Ø¨Ø¯Ø£ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</div>'; return; }
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                display.innerHTML = `<div class="timer-box"><span class="timer-number">${seconds}</span><span class="timer-label">Ø«Ø§Ù†ÙŠØ©</span></div><div class="timer-box"><span class="timer-number">${minutes}</span><span class="timer-label">Ø¯Ù‚ÙŠÙ‚Ø©</span></div><div class="timer-box"><span class="timer-number">${hours}</span><span class="timer-label">Ø³Ø§Ø¹Ø©</span></div><div class="timer-box"><span class="timer-number">${days}</span><span class="timer-label">ÙŠÙˆÙ…</span></div>`;
            }
            setInterval(update, 1000);
            select.addEventListener('change', update);
            update();
        }
        document.addEventListener('DOMContentLoaded', startCountdown);

        const examConfig = {
            "bac_n": { file: "bac_n.csv", searchKeys: ["NODOSS", "Num", "NÂ°"], nameKeys: ["NOM_AR", "Nom"], scoreKeys: ["Moy Bac", "Moyenne"], placeKeys: ["Etablissement_AR", "Etablissement"], decisionKeys: ["Decision"], stateKeys: ["Wilaya_AR", "Wilaya"], majorKeys: ["SERIE", "Serie"] },
            "bac_c": { file: "bac_c.csv", searchKeys: ["NODOSS", "Num"], nameKeys: ["NOM_AR", "Nom"], scoreKeys: ["Moy Bac_Session", "Moy Bac"], placeKeys: ["Etablissement_AR", "Etablissement"], decisionKeys: ["Decision"], stateKeys: ["Wilaya_AR", "Wilaya"], majorKeys: ["SERIE", "Serie"] },
            "brevet": { file: "brevet.csv", searchKeys: ["Num_Bepc", "Num"], nameKeys: ["NOM", "Nom"], scoreKeys: ["Moyenne_Bepc", "Moyenne"], placeKeys: ["Ecole", "Etablissement"], decisionKeys: ["Decision"], stateKeys: ["WILAYA", "Wilaya"], majorKeys: [] },
            "concours": { file: "concours.csv", searchKeys: ["Noreg", "NODOSS"], nameKeys: ["NOM_AR", "Nom"], scoreKeys: ["TOTAL", "Score"], placeKeys: ["Ecole_AR", "Ecole"], decisionKeys: [], stateKeys: ["WILAYA_AR", "Wilaya"], majorKeys: [] }
        };

        const staticMajors = [ { label: "Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© (SN)", searchVal: ["SN"] }, { label: "Ø§Ù„Ø¢Ø¯Ø§Ø¨ Ø§Ù„Ø£ØµÙ„ÙŠØ© (LO)", searchVal: ["LO"] }, { label: "Ø§Ù„Ø¢Ø¯Ø§Ø¨ Ø§Ù„Ø¹ØµØ±ÙŠØ© (LM)", searchVal: ["LM"] }, { label: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª (M)", searchVal: ["M", "C"] }, { label: "Ø§Ù„ØªÙ‚Ù†ÙŠØ© (TM)", searchVal: ["TM", "T"] }, { label: "Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ© (TS)", searchVal: ["TS"] }, { label: "Ø§Ù„Ù„ØºØ§Øª (LA)", searchVal: ["LA"] } ];
        const staticWilayas = [ { label: "Ø§Ù„Ø­ÙˆØ¶ Ø§Ù„Ø´Ø±Ù‚ÙŠ", searchVal: ["Ø§Ù„Ø­ÙˆØ¶ Ø§Ù„Ø´Ø±Ù‚ÙŠ", "Hod Charghi"] }, { label: "Ø§Ù„Ø­ÙˆØ¶ Ø§Ù„ØºØ±Ø¨ÙŠ", searchVal: ["Ø§Ù„Ø­ÙˆØ¶ Ø§Ù„ØºØ±Ø¨ÙŠ", "Hod Gharbi"] }, { label: "Ù„Ø¹ØµØ§Ø¨Ù‡", searchVal: ["Ù„Ø¹ØµØ§Ø¨Ù‡", "ASSABA"] }, { label: "ÙƒÙˆØ±ÙƒÙ„", searchVal: ["ÙƒÙˆØ±ÙƒÙ„", "GORGOL"] }, { label: "Ù„Ø¨Ø±Ø§ÙƒÙ†Ù‡", searchVal: ["Ù„Ø¨Ø±Ø§ÙƒÙ†Ù‡", "BRAKNA"] }, { label: "Ø§ØªØ±Ø§Ø±Ø²Ù‡", searchVal: ["Ø§ØªØ±Ø§Ø±Ø²Ù‡", "TRARZA"] }, { label: "Ø¢Ø¯Ø±Ø§Ø±", searchVal: ["Ø¢Ø¯Ø±Ø§Ø±", "ADRAR"] }, { label: "Ø¯Ø§Ø®Ù„Øª Ø§Ù†ÙˆØ§Ø°ÙŠØ¨Ùˆ", searchVal: ["Ø¯Ø§Ø®Ù„Øª Ø§Ù†ÙˆØ§Ø°ÙŠØ¨Ùˆ", "NOUADHIBOU"] }, { label: "ØªÙƒØ§Ù†Øª", searchVal: ["ØªÙƒØ§Ù†Øª", "TAGANT"] }, { label: "ÙƒÙŠØ¯ÙŠÙ…Ø§ØºØ§", searchVal: ["ÙƒÙŠØ¯ÙŠÙ…Ø§ØºØ§", "GUIDIMAGHA"] }, { label: "ØªÙŠØ±Ø³ Ø²Ù…ÙˆØ±", searchVal: ["ØªÙŠØ±Ø³ Ø²Ù…ÙˆØ±", "TIRIS ZEMMOUR"] }, { label: "Ø§ÙŠÙ†Ø´ÙŠØ±ÙŠ", searchVal: ["Ø§ÙŠÙ†Ø´ÙŠØ±ÙŠ", "INCHIRI"] }, { label: "Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· 1 (Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©)", searchVal: ["Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©", "NKTT NORD", "NORD"] }, { label: "Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· 2 (Ø§Ù„ØºØ±Ø¨ÙŠØ©)", searchVal: ["Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· Ø§Ù„ØºØ±Ø¨ÙŠØ©", "Nouakchott Ouest", "NKTT OUEST"] }, { label: "Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· 3 (Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠØ©)", searchVal: ["Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠØ©", "NKTT SUD", "SUD"] } ];

        const examSelect = document.getElementById('examType');
        const categorySelect = document.getElementById('searchCategory');
        function updateSearchCategory() { categorySelect.value = examSelect.value === 'concours' ? 'school' : 'number'; }
        examSelect.addEventListener('change', updateSearchCategory);
        document.addEventListener('DOMContentLoaded', updateSearchCategory);

        let cache = {}; 
        let currentFilteredResults = [], currentRenderCount = 0, currentBatchSize = 100, currentSearchConfig = null, currentSearchExamType = null, currentSearchMode = 'school';

        function getVal(item, keysArray) { if (!item || !keysArray) return ""; for (let key of keysArray) { if (item[key] !== undefined && item[key] !== null) return item[key]; } return ""; }
        function parseScore(val) { if (!val) return 0; let clean = String(val).trim().replace(/[^0-9.,]/g, '').replace(',', '.'); let num = parseFloat(clean); return isNaN(num) ? 0 : num; }
        function getNormalizedState(rawState) {
            if (!rawState) return "unknown";
            let text = String(rawState).trim().toLowerCase().replace(/\s+/g, ' ');
            if (text.includes('ouest') || text.includes('Ø§Ù„ØºØ±Ø¨ÙŠØ©')) return "Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· 2 (Ø§Ù„ØºØ±Ø¨ÙŠØ©)";
            if (text.includes('nord') || text.includes('Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©')) return "Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· 1 (Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©)";
            if (text.includes('sud') || text.includes('Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠØ©')) return "Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· 3 (Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠØ©)";
            for (let group of staticWilayas) { if(group.label.includes("Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ·")) continue; if (group.searchVal.some(term => text.includes(term.toLowerCase()))) return group.label; }
            return text;
        }

        function isResultSuccessful(student, config, examType) {
            if (examType === 'concours') {
                const score = parseScore(getVal(student, config.scoreKeys));
                return score >= 85; // ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø¥Ù„Ù‰ 85 Ù„Ù„ÙƒÙˆÙ†ÙƒÙˆØ±
            }
            const decisionRaw = getVal(student, config.decisionKeys);
            if (!decisionRaw) return false;
            let d = String(decisionRaw).toLowerCase();
            return d.includes('admis') || d.includes('Ù†Ø§Ø¬Ø­');
        }

        // ==============================================
        // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø©
        // ==============================================
        function calculateAndRenderStats(data, config, examType) {
            const container = document.getElementById('statsContainer');
            container.innerHTML = '';
            container.classList.remove('d-none');

            let totalStudents = data.length;
            let totalAdmis = 0;
            let wilayaStats = {}, schoolStats = {}, serieStats = {};

            data.forEach(student => {
                let isPass = isResultSuccessful(student, config, examType);
                if (isPass) totalAdmis++;

                let w = student._stateNorm;
                if (w !== 'unknown') {
                    if (!wilayaStats[w]) wilayaStats[w] = { total: 0, pass: 0 };
                    wilayaStats[w].total++;
                    if (isPass) wilayaStats[w].pass++;
                }

                let s = getVal(student, config.placeKeys).trim();
                if (s) {
                    if (!schoolStats[s]) schoolStats[s] = { total: 0, pass: 0 };
                    schoolStats[s].total++;
                    if (isPass) schoolStats[s].pass++;
                }

                if (examType.includes('bac')) {
                    let serie = getVal(student, config.majorKeys);
                    if (serie) {
                        if (!serieStats[serie]) serieStats[serie] = { total: 0, pass: 0 };
                        serieStats[serie].total++;
                        if (isPass) serieStats[serie].pass++;
                    }
                }
            });

            // ØªØ­Ø¶ÙŠØ± Ù…ØµÙÙˆÙØ© Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª Ù…Ø¹ Ø§Ù„ØªØ±ØªÙŠØ¨
            let sortedWilayas = Object.keys(wilayaStats).map(key => {
                return { name: key, rate: (wilayaStats[key].pass / wilayaStats[key].total) * 100, count: wilayaStats[key].pass, total: wilayaStats[key].total };
            }).sort((a, b) => b.rate - a.rate);

            // ØªØ­Ø¶ÙŠØ± Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø¯Ø§Ø±Ø³ (Ø´Ø±Ø·: Ø£ÙƒØ«Ø± Ù…Ù† 20 Ø·Ø§Ù„Ø¨)
            let sortedSchools = Object.keys(schoolStats).map(key => {
                return { name: key, rate: (schoolStats[key].pass / schoolStats[key].total) * 100, count: schoolStats[key].pass, total: schoolStats[key].total };
            }).filter(s => s.total >= 20).sort((a, b) => b.rate - a.rate);

            // ØªØ­Ø¶ÙŠØ± Ù…ØµÙÙˆÙØ© Ø§Ù„Ø´Ø¹Ø¨
            let sortedSeries = Object.keys(serieStats).map(key => {
                return { name: key, rate: (serieStats[key].pass / serieStats[key].total) * 100 };
            }).sort((a, b) => b.rate - a.rate);

            let nationalRate = ((totalAdmis / totalStudents) * 100).toFixed(2);

            // --- Ø¨Ù†Ø§Ø¡ HTML ---
            let html = `
                <div class="stat-box" style="background: linear-gradient(135deg, #e0f2f1, #ffffff); border-right: 5px solid var(--primary);">
                    <div>
                        <div class="small text-muted">Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„ÙˆØ·Ù†ÙŠØ©</div>
                        <div class="stat-rate" style="font-size: 1.5rem; color: #00695c;">%${nationalRate}</div>
                    </div>
                    <div class="text-center"><i class="fas fa-flag fa-2x text-muted opacity-25"></i></div>
                </div>
            `;

            // Ø£ÙØ¶Ù„ 3 ÙˆÙ„Ø§ÙŠØ§Øª
            html += `<div class="stats-section-title"><i class="fas fa-trophy me-2"></i>Ø£ÙØ¶Ù„ 3 ÙˆÙ„Ø§ÙŠØ§Øª</div>`;
            sortedWilayas.slice(0, 3).forEach((w, index) => {
                html += `
                <div class="stat-box">
                    <div class="d-flex align-items-center">
                        <div class="stat-rank rank-${index+1}">${index+1}</div>
                        <div class="ms-2">
                            <div class="stat-name">${w.name}</div>
                            <div class="stat-meta text-muted">Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø§Ø¬Ø­ÙŠÙ†: ${w.count} / ${w.total}</div>
                        </div>
                    </div>
                    <div class="stat-rate text-success">%${w.rate.toFixed(2)}</div>
                </div>`;
            });

            // ØªØ±ØªÙŠØ¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª (Ø¬Ø¯ÙˆÙ„ Ù…Ø¶ØºÙˆØ·)
            html += `<div class="stats-section-title"><i class="fas fa-map-marker-alt me-2"></i>ØªØ±ØªÙŠØ¨ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª (Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­)</div>`;
            html += `<div class="table-responsive bg-white rounded p-2 border"><table class="table table-sm table-striped mb-0 small">
                <thead><tr><th>Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</th><th class="text-end">Ø§Ù„Ù†Ø³Ø¨Ø©</th></tr></thead><tbody>`;
            sortedWilayas.forEach(w => {
                html += `<tr><td>${w.name}</td><td class="text-end fw-bold text-success">%${w.rate.toFixed(2)}</td></tr>`;
            });
            html += `</tbody></table></div>`;

            // Ø£ÙØ¶Ù„ 10 Ù…Ø¯Ø§Ø±Ø³ (Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø¶ØºØ·)
            if(sortedSchools.length > 0) {
                html += `<div class="stats-section-title"><i class="fas fa-school me-2"></i>Ø£ÙØ¶Ù„ 10 Ù…Ø¯Ø§Ø±Ø³ (Ø£ÙƒØ«Ø± Ù…Ù† 20 Ù…ØªØ±Ø´Ø­)</div>`;
                sortedSchools.slice(0, 10).forEach((s, index) => {
                    const safeName = s.name.replace(/'/g, "\\'");
                    html += `
                    <div class="stat-box" style="cursor:pointer;" onclick="searchBySchoolName('${safeName}')">
                        <div class="d-flex align-items-center" style="overflow:hidden;">
                            <div class="stat-rank">${index+1}</div>
                            <div class="ms-2 text-truncate">
                                <div class="stat-name text-truncate text-primary" style="text-decoration:underline;">${s.name}</div>
                                <div class="stat-meta">Ø§Ø¶ØºØ· Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</div>
                            </div>
                        </div>
                        <div class="stat-rate text-success ms-2">%${s.rate.toFixed(1)}</div>
                    </div>`;
                });
            }

            // Ø£ÙØ¶Ù„ 5 Ø´Ø¹Ø¨ (Ù„Ù„Ø¨ÙƒØ§Ù„ÙˆØ±ÙŠØ§)
            if(sortedSeries.length > 0) {
                html += `<div class="stats-section-title"><i class="fas fa-book me-2"></i>Ø£ÙØ¶Ù„ 5 Ø´Ø¹Ø¨</div>`;
                html += `<div class="stat-grid-compact">`;
                sortedSeries.slice(0, 5).forEach(s => {
                    html += `
                    <div class="stat-mini-card">
                        <div class="fw-bold text-dark small">${s.name}</div>
                        <div class="text-success fw-bold">%${s.rate.toFixed(1)}</div>
                    </div>`;
                });
                html += `</div>`;
            }

            html += `<hr class="my-4">`;
            container.innerHTML = html;
        }

        async function loadNationalTop() {
            document.getElementById('topMenu').classList.add('d-none');
            document.getElementById('backBtn').classList.remove('d-none');
            document.getElementById('selectionListContainer').classList.add('d-none');
            
            const examType = document.getElementById('examType').value;
            const config = examConfig[examType];
            const container = document.getElementById('topPageResults');
            
            container.innerHTML = '<div class="text-center"><div class="spinner-border text-success"></div></div>';
            
            try {
                const data = await fetchData(examType);
                calculateAndRenderStats(data, config, examType);
                container.innerHTML = '<h6 class="text-center fw-bold text-success mb-3">Ø£Ø¹Ù„Ù‰ 20 Ù…Ø¹Ø¯Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ÙˆØ·Ù†ÙŠ</h6>';
                data.slice(0, 20).forEach((student, index) => {
                    renderCard(student, config, container, index + 1, examType, 'top');
                });
            } catch (e) { container.innerHTML = `<div class="alert alert-danger">Ø®Ø·Ø£: ${e.message}</div>`; }
        }

        function searchBySchoolName(schoolName) {
            document.getElementById('topPageOverlay').style.display = 'none';
            document.getElementById('searchCategory').value = 'school';
            document.getElementById('searchInput').value = schoolName;
            document.querySelector('.container-app').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('searchBtn').click();
        }

        function searchByNumber(num) {
            document.getElementById('topPageOverlay').style.display = 'none';
            document.getElementById('searchCategory').value = 'number';
            document.getElementById('searchInput').value = num;
            document.querySelector('.container-app').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('searchBtn').click();
        }

        async function fetchData(examType) {
            if (cache[examType]) return cache[examType];
            const config = examConfig[examType];
            try {
                const response = await fetch(config.file);
                if (!response.ok) throw new Error(`Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
                const csvText = await response.text();
                const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true, transformHeader: h => h.trim() });
                if(parsed.data.length === 0) throw new Error("Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº");
                const processedData = preprocessData(parsed.data, config, examType);
                cache[examType] = processedData;
                return processedData;
            } catch (error) { throw error; }
        }

        function preprocessData(data, config, examType) {
            data.sort((a, b) => parseScore(getVal(b, config.scoreKeys)) - parseScore(getVal(a, config.scoreKeys)));
            let stateCounters = {}, schoolCounters = {}, serieCounters = {};
            data.forEach((student, index) => {
                student._score = parseScore(getVal(student, config.scoreKeys));
                student._nationalRank = index + 1;
                let stateRaw = getVal(student, config.stateKeys);
                let stateNorm = getNormalizedState(stateRaw);
                student._stateNorm = stateNorm; 
                if (stateNorm !== 'unknown') {
                    if (!stateCounters[stateNorm]) stateCounters[stateNorm] = 0;
                    stateCounters[stateNorm]++;
                    student._stateRank = stateCounters[stateNorm];
                }
                let school = getVal(student, config.placeKeys).trim();
                if (school) {
                    if (!schoolCounters[school]) schoolCounters[school] = 0;
                    schoolCounters[school]++;
                    student._schoolRank = schoolCounters[school];
                }
                if (examType.includes('bac')) {
                    let serie = getVal(student, config.majorKeys);
                    if (serie) {
                        if (!serieCounters[serie]) serieCounters[serie] = 0;
                        serieCounters[serie]++;
                        student._serieRank = serieCounters[serie];
                        student._serie = serie;
                    }
                }
            });
            return data;
        }

        document.getElementById('searchBtn').addEventListener('click', async () => {
            const examType = document.getElementById('examType').value;
            const searchCat = document.getElementById('searchCategory').value;
            const inputVal = document.getElementById('searchInput').value.trim().toLowerCase();
            const config = examConfig[examType];
            if (!inputVal) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ù„Ù„Ø¨Ø­Ø«");
            const container = document.getElementById('resultsContainer');
            const loading = document.getElementById('loading');
            container.innerHTML = '';
            loading.classList.remove('d-none');
            setTimeout(async () => {
                try {
                    const data = await fetchData(examType);
                    let results = [];
                    if (searchCat === 'number') {
                        results = data.filter(item => String(getVal(item, config.searchKeys)).trim().toLowerCase() === inputVal);
                    } else {
                        results = data.filter(item => String(getVal(item, config.placeKeys)).toLowerCase().includes(inputVal));
                    }
                    loading.classList.add('d-none');
                    if (results.length === 0) { container.innerHTML = '<div class="alert alert-warning text-center">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬.</div>'; return; }
                    container.innerHTML = `<div class="alert alert-success text-center fw-bold">ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${results.length} Ù†ØªÙŠØ¬Ø©</div>`;
                    currentFilteredResults = results; currentRenderCount = 0; currentSearchConfig = config; currentSearchExamType = examType; currentSearchMode = searchCat; 
                    renderNextBatch();
                    setTimeout(() => { const firstResult = document.querySelector('.result-card-wrapper'); if (firstResult) firstResult.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100);
                    if (searchCat === 'number' && results.length > 0) { const winner = results.find(s => isResultSuccessful(s, config, examType)); if (winner) triggerCelebration(); }
                } catch (error) { loading.classList.add('d-none'); alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message); }
            }, 50);
        });

        function renderNextBatch() {
            const container = document.getElementById('resultsContainer');
            const oldBtn = document.getElementById('showMoreBtn');
            if(oldBtn) oldBtn.remove();
            const nextLimit = Math.min(currentRenderCount + currentBatchSize, currentFilteredResults.length);
            for (let i = currentRenderCount; i < nextLimit; i++) {
                renderCard(currentFilteredResults[i], currentSearchConfig, container, null, currentSearchExamType, currentSearchMode);
            }
            currentRenderCount = nextLimit;
            if (currentRenderCount < currentFilteredResults.length) {
                const remaining = currentFilteredResults.length - currentRenderCount;
                const nextCount = Math.min(currentBatchSize, remaining);
                container.innerHTML += `<button id="showMoreBtn" class="btn-show-more" onclick="renderNextBatch()">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ (${nextCount}) <i class="fas fa-chevron-down"></i></button>`;
            }
        }

        function openTopPage() { resetTopView(); const examType = document.getElementById('examType').value; const majorBtnCol = document.getElementById('majorBtnCol'); const stateBtnCol = document.getElementById('stateBtnCol'); majorBtnCol.style.display = 'none'; stateBtnCol.style.display = 'none'; if (examType.includes('bac')) { majorBtnCol.style.display = 'block'; stateBtnCol.style.display = 'block'; stateBtnCol.className = 'col-6'; } else if (examType === 'brevet') { stateBtnCol.style.display = 'block'; stateBtnCol.className = 'col-12'; } document.getElementById('topPageOverlay').style.display = 'block'; }
        function closeTopPage() { document.getElementById('topPageOverlay').style.display = 'none'; }
        function resetTopView() { document.getElementById('topMenu').classList.remove('d-none'); document.getElementById('selectionListContainer').classList.add('d-none'); document.getElementById('topPageResults').innerHTML = ''; document.getElementById('statsContainer').classList.add('d-none'); document.getElementById('backBtn').classList.add('d-none'); }
        function renderGroupList(groupBy) { document.getElementById('topMenu').classList.add('d-none'); document.getElementById('backBtn').classList.remove('d-none'); const listContainer = document.getElementById('selectionListContainer'); const itemsDiv = document.getElementById('selectionItems'); document.getElementById('selectionTitle').innerText = groupBy === 'wilaya' ? 'Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ©:' : 'Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©:'; listContainer.classList.remove('d-none'); itemsDiv.innerHTML = ''; let items = groupBy === 'wilaya' ? staticWilayas : staticMajors; items.forEach(item => { let col = document.createElement('div'); col.className = 'col-12'; col.innerHTML = `<div class="selection-btn"><span>${item.label}</span><i class="fas fa-chevron-left selection-icon"></i></div>`; col.onclick = () => loadTopTenForGroup(groupBy, item.searchVal, item.label); itemsDiv.appendChild(col); }); }
        
        async function loadTopTenForGroup(groupBy, searchTerms, label) {
            document.getElementById('selectionListContainer').classList.add('d-none');
            const container = document.getElementById('topPageResults');
            container.innerHTML = '<div class="text-center"><div class="spinner-border text-success"></div></div>';
            const examType = document.getElementById('examType').value;
            const config = examConfig[examType];
            let targetKeys = groupBy === 'wilaya' ? config.stateKeys : config.majorKeys;
            try {
                const data = await fetchData(examType);
                let filtered = data.filter(item => {
                    let val = String(getVal(item, targetKeys)).trim();
                    if (groupBy === 'wilaya') { const studentNormalized = getNormalizedState(val); return studentNormalized === label; } 
                    else { return searchTerms.some(term => val.toLowerCase() === term.toLowerCase() || val.includes(term)); }
                });
                filtered.sort((a, b) => parseScore(getVal(b, config.scoreKeys)) - parseScore(getVal(a, config.scoreKeys)));
                container.innerHTML = `<h6 class="text-center fw-bold text-primary mb-3">Ø§Ù„Ø¹Ø´Ø±Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„: ${label}</h6>`;
                if(filtered.length === 0) container.innerHTML += '<div class="alert alert-warning text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</div>';
                else { filtered.slice(0, 10).forEach((student, index) => { renderCard(student, config, container, index + 1, examType, 'top'); }); }
            } catch (e) { container.innerHTML = `<div class="alert alert-danger">Ø®Ø·Ø£: ${e.message}</div>`; }
        }

        function renderCard(student, config, targetElement, rank = null, examType = '', searchMode = '') {
            const name = getVal(student, config.nameKeys) || 'Ø§Ø³Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±';
            const number = getVal(student, config.searchKeys);
            const score = student._score; 
            const place = getVal(student, config.placeKeys);
            const decisionRaw = getVal(student, config.decisionKeys);
            let state = student._stateNorm; if(state === "unknown") state = getVal(student, config.stateKeys);
            let isAdmis = false, decisionHtml = '', cardClass = '', encouragementMsg = '';
            
            // ØªØ­Ø¯ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ ÙˆØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù†
            if (examType === 'concours') {
                if (score >= 85) { decisionHtml = `<span class="badge bg-white text-success border border-white">Ù†Ø§Ø¬Ø­</span>`; isAdmis = true; cardClass = 'card-admis'; }
                else { decisionHtml = `<span class="badge bg-white text-danger border border-white">Ø±Ø§Ø³Ø¨</span>`; cardClass = 'card-recale'; encouragementMsg = `<div class="mt-2 text-center p-2 rounded" style="background: rgba(255,255,255,0.2); border: 1px dashed rgba(255,255,255,0.5);"><span class="small fw-bold text-white"><i class="fas fa-heart me-1"></i> ÙÙŠÙ‡ Ø®ÙŠØ± Ù„Ø§ ØªÙŠØ£Ø³ ÙˆØ§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ğŸ’ª</span></div>`; }
            } else {
                if (decisionRaw) {
                    let d = String(decisionRaw).toLowerCase();
                    if (d.includes('admis') || d.includes('Ù†Ø§Ø¬Ø­')) { decisionHtml = `<span class="badge bg-white text-success border border-white">${decisionRaw}</span>`; isAdmis = true; cardClass = 'card-admis'; } 
                    else if (d.includes('session') || d.includes('Ù…Ø¤Ø¬Ù„')) { decisionHtml = `<span class="badge bg-white text-warning border border-white">${decisionRaw}</span>`; cardClass = 'card-session'; } 
                    else { decisionHtml = `<span class="badge bg-white text-danger border border-white">${decisionRaw}</span>`; cardClass = 'card-recale'; encouragementMsg = `<div class="mt-2 text-center p-2 rounded" style="background: rgba(255,255,255,0.2); border: 1px dashed rgba(255,255,255,0.5);"><span class="small fw-bold text-white"><i class="fas fa-heart me-1"></i> ÙÙŠÙ‡ Ø®ÙŠØ± Ù„Ø§ ØªÙŠØ£Ø³ ÙˆØ§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ğŸ’ª</span></div>`; }
                }
            }

            let rankBadge = rank ? `<div class="rank-badge">${rank}</div>` : '';
            let extraStyle = rank ? 'padding-left: 50px;' : '';
            let gridHtml = '', items = [];
            if(student._serie) items.push({l: 'Ø§Ù„Ø´Ø¹Ø¨Ø©', v: student._serie});
            if(student._serieRank) items.push({l: 'Ø§Ù„Ø±ØªØ¨Ø© ÙÙŠ Ø§Ù„Ø´Ø¹Ø¨Ø©', v: student._serieRank});
            if(student._nationalRank) items.push({l: 'Ø§Ù„Ø±ØªØ¨Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ©', v: student._nationalRank});
            if(student._stateRank) items.push({l: 'Ø§Ù„Ø±ØªØ¨Ø© ÙÙŠ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©', v: student._stateRank});
            if(student._schoolRank) items.push({l: 'Ø§Ù„Ø±ØªØ¨Ø© ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ²', v: student._schoolRank});
            if (items.length > 0) { gridHtml = `<div class="info-grid">`; items.forEach(item => { gridHtml += `<div class="info-item"><span class="info-label">${item.l}</span><span class="info-value">${item.v}</span></div>`; }); gridHtml += `</div>`; }
            let whatsappActions = '';
            if (isAdmis && searchMode === 'number' && (examType === 'bac_n' || examType === 'bac_c')) {
                 whatsappActions += `<a href="${orientationGroupLink}" target="_blank" class="whatsapp-card"><div class="d-flex align-items-center"><div class="icon-circle icon-whatsapp"><i class="fas fa-university"></i></div><div><h6 class="fw-bold mb-1" style="color:#0f5132">ğŸ“ ØªÙˆØ¬ÙŠÙ‡ ÙˆØªØ®ØµØµØ§Øª</h6><p class="m-0 small text-secondary">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø´Ø±Ø­ Ø§Ù„ØªØ®ØµØµØ§Øª.</p></div></div></a>`;
            }
            const safePlace = place.replace(/'/g, "\\'");
            const cardId = 'card_' + Math.random().toString(36).substr(2, 9);
            const currentUrl = window.location.href.split('?')[0];
            targetElement.innerHTML += `
                <div class="result-card-wrapper">
                    <div id="${cardId}" class="result-card ${cardClass}">
                        ${rankBadge}
                        <div style="${extraStyle}">
                            <h6 class="fw-bold mb-1">${name}</h6>
                            <div class="small text-muted row">
                                <div class="col-6">Ø±Ù‚Ù…: <b class="number-link" onclick="searchByNumber('${number}')">${number}</b></div>
                                <div class="col-6 text-end">Ø§Ù„Ù…Ø¹Ø¯Ù„: <b class="text-success">${score % 1 !== 0 ? score.toFixed(2) : score}</b></div>
                            </div>
                            <div class="small text-muted mt-1"><i class="fas fa-school me-1"></i> <span class="school-link" onclick="searchBySchoolName('${safePlace}')">${place}</span></div>
                            ${gridHtml}
                            <div class="mt-2 d-flex justify-content-between align-items-center">${decisionHtml}${state ? `<span class="badge bg-light text-dark border">${state}</span>` : ''}</div>
                            ${encouragementMsg}
                            <div class="watermark d-none mt-3 pt-2 border-top border-white border-opacity-25 text-center"><div class="d-flex align-items-center justify-content-center gap-2"><div class="small text-white opacity-75 fw-bold"><i class="fas fa-globe me-1"></i> ${currentUrl.replace('https://', '')}</div></div></div>
                        </div>
                    </div>
                    <button class="btn-share" onclick="shareResult('${cardId}')"><i class="fas fa-share-alt me-2"></i> Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙƒØµÙˆØ±Ø©</button>
                    ${whatsappActions}
                </div>`;
        }

        async function shareResult(elementId) {
            const element = document.getElementById(elementId);
            const watermark = element.querySelector('.watermark');
            if(watermark) watermark.classList.remove('d-none');
            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²...';
            btn.disabled = true;
            try {
                const canvas = await html2canvas(element, { scale: 2, backgroundColor: null, useCORS: true });
                if(watermark) watermark.classList.add('d-none');
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], "resultat-rim.png", { type: "image/png" });
                    const siteUrl = window.location.href;
                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        try { await navigator.share({ title: 'Ù†ØªÙŠØ¬ØªÙŠ ÙÙŠ Resultat RIM', text: `Ø·Ø§Ù„Ø¹ Ù†ØªÙŠØ¬ØªÙŠ ÙÙŠ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„ÙˆØ·Ù†ÙŠØ© Ø§Ù„Ù…ÙˆØ±ÙŠØªØ§Ù†ÙŠØ© ğŸ‡²ğŸ‡·\nØ§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ù†ØªÙŠØ¬ØªÙƒ: ${siteUrl}`, url: siteUrl, files: [file] }); } catch (err) { console.log('User cancelled share'); }
                    } else {
                        const link = document.createElement('a'); link.download = 'resultat-rim.png'; link.href = canvas.toDataURL(); link.click(); alert("ØªÙ… Ø­ÙØ¸ ØµÙˆØ±Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ø¬Ù‡Ø§Ø²Ùƒ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
                    }
                    btn.innerHTML = originalText; btn.disabled = false;
                });
            } catch (err) { console.error(err); alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø©."); if(watermark) watermark.classList.add('d-none'); btn.innerHTML = originalText; btn.disabled = false; }
        }

        const simData = {
            "brevet": [ { name: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", coef: 5 }, { name: "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", coef: 3 }, { name: "Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©", coef: 2 }, { name: "Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©", coef: 2 }, { name: "Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ ÙˆØ§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡", coef: 2 }, { name: "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", coef: 2 }, { name: "Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", coef: 1 }, { name: "Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§", coef: 1 }, { name: "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ù…Ø¯Ù†ÙŠØ©", coef: 1 }, { name: "Ø§Ù„Ø±ÙŠØ§Ø¶Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ©", coef: 1 } ],
            "bac_sn": [ { name: "Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©", coef: 8 }, { name: "Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ ÙˆØ§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡", coef: 7 }, { name: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", coef: 6 }, { name: "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", coef: 3 }, { name: "Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©", coef: 3 }, { name: "Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", coef: 2 }, { name: "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", coef: 2 }, { name: "Ø§Ù„Ø±ÙŠØ§Ø¶Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ©", coef: 1 } ],
            "bac_m": [ { name: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", coef: 9 }, { name: "Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ ÙˆØ§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡", coef: 8 }, { name: "Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©", coef: 4 }, { name: "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", coef: 3 }, { name: "Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©", coef: 3 }, { name: "Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", coef: 2 }, { name: "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", coef: 2 }, { name: "Ø§Ù„Ø±ÙŠØ§Ø¶Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ©", coef: 1 } ],
            "bac_lm": [ { name: "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", coef: 6 }, { name: "Ø§Ù„ÙÙ„Ø³ÙØ©", coef: 6 }, { name: "Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©", coef: 6 }, { name: "Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§", coef: 5 }, { name: "Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", coef: 4 }, { name: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", coef: 2 }, { name: "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", coef: 2 }, { name: "Ø§Ù„Ø±ÙŠØ§Ø¶Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ©", coef: 1 } ],
            "bac_lo": [ { name: "Ø§Ù„ØªØ´Ø±ÙŠØ¹ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ", coef: 7 }, { name: "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", coef: 7 }, { name: "Ø§Ù„ÙÙƒØ± Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ", coef: 6 }, { name: "Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§", coef: 4 }, { name: "Ø§Ù„Ù‚Ø±Ø¢Ù† ÙˆØ§Ù„Ø­Ø¯ÙŠØ«", coef: 3 }, { name: "Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©", coef: 2 }, { name: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", coef: 2 }, { name: "Ø§Ù„Ø±ÙŠØ§Ø¶Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ©", coef: 1 } ],
            "bac_tm": [ { name: "Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©/Ø§Ù„Ø±Ø³Ù… Ø§Ù„ØªÙ‚Ù†ÙŠ", coef: 7 }, { name: "Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª/Ø§Ù„ØªØ®ØµØµ", coef: 6 }, { name: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", coef: 4 }, { name: "Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ ÙˆØ§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡", coef: 3 }, { name: "Ø§Ù„ÙˆØ±Ø´Ø© (Atelier)", coef: 3 }, { name: "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", coef: 2 }, { name: "Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©", coef: 2 }, { name: "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", coef: 2 }, { name: "Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", coef: 1 }, { name: "Ø§Ù„Ø±ÙŠØ§Ø¶Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ©", coef: 1 } ]
        };

        function openSimulator() { document.getElementById('simulatorOverlay').style.display = 'block'; renderSimulatorInputs(); }
        function closeSimulator() { document.getElementById('simulatorOverlay').style.display = 'none'; }
        function renderSimulatorInputs() {
            const type = document.getElementById('simType').value;
            const container = document.getElementById('simInputsContainer');
            const subjects = simData[type];
            container.innerHTML = '';
            subjects.forEach((sub, idx) => {
                container.innerHTML += `<div class="subject-row"><div class="d-flex align-items-center"><span class="coeff-badge">Ø¶: ${sub.coef}</span><span class="fw-bold text-secondary" style="font-size: 0.9rem;">${sub.name}</span></div><input type="number" inputmode="decimal" class="grade-input" placeholder="0" min="0" max="20" data-coef="${sub.coef}" oninput="calculateSimScore()"></div>`;
            });
            calculateSimScore();
        }
        function calculateSimScore() {
            const inputs = document.querySelectorAll('.grade-input');
            let totalPoints = 0, totalCoef = 0;
            inputs.forEach(input => { let val = parseFloat(input.value); let coef = parseInt(input.getAttribute('data-coef')); if (!isNaN(val)) { if (val > 20) val = 20; if (val < 0) val = 0; totalPoints += val * coef; } totalCoef += coef; });
            const average = totalCoef > 0 ? (totalPoints / totalCoef).toFixed(4) : "00.00";
            document.getElementById('simResult').innerText = parseFloat(average).toFixed(2);
            document.getElementById('simTotalPoints').innerText = totalPoints.toFixed(2);
            document.getElementById('simTotalCoef').innerText = totalCoef;
            const resultEl = document.getElementById('simResult');
            if(parseFloat(average) >= 10) { resultEl.style.color = '#fff'; resultEl.parentElement.style.background = 'linear-gradient(135deg, var(--primary), #25D366)'; } 
            else { resultEl.style.color = '#ffeb3b'; resultEl.parentElement.style.background = 'linear-gradient(135deg, var(--secondary), var(--primary))'; }
        }

        // Functions for celebration confetti
        const emojis = ['ğŸŒ¸', 'ğŸŒ¹', 'ğŸ’', 'â¤ï¸', 'ğŸ‰', 'ğŸŠ', 'ğŸŒ·', 'âœ¨', 'ğŸ’•', 'ğŸ¥°'];
        let celebrationInterval;
        function createConfetti() { const overlay = document.getElementById('celebrationOverlay'); if(overlay.style.display === 'none') return; const el = document.createElement('div'); el.classList.add('confetti-piece'); el.innerText = emojis[Math.floor(Math.random() * emojis.length)]; el.style.left = Math.random() * 100 + 'vw'; el.style.animationDuration = (Math.random() * 3 + 2) + 's'; el.style.fontSize = (Math.random() * 20 + 20) + 'px'; overlay.appendChild(el); setTimeout(() => { el.remove(); }, 5000); }
        function triggerCelebration() { const overlay = document.getElementById('celebrationOverlay'); overlay.style.display = 'flex'; if(celebrationInterval) clearInterval(celebrationInterval); celebrationInterval = setInterval(createConfetti, 100); }
        function closeCelebration() { document.getElementById('celebrationOverlay').style.display = 'none'; if(celebrationInterval) clearInterval(celebrationInterval); document.querySelectorAll('.confetti-piece').forEach(e => e.remove()); }
    </script>
</body>
</html>