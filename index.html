<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª PWA -->
    <meta name="theme-color" content="#00695c">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Resultat Rim">

    <title>Resultat Rim | Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙˆØ·Ù†ÙŠØ©</title>
    
    <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        :root {
            --primary: #00695c;
            --secondary: #004d40;
            --gold: #ffc107;
            --whatsapp: #25D366;
            --bg: #f0f2f5;
            --card: #ffffff;
            --radius: 16px;
        }
        body { font-family: 'Cairo', sans-serif; background: var(--bg); padding-bottom: 50px; overflow-x: hidden; }
        
        .navbar { background: linear-gradient(135deg, var(--primary), var(--secondary)); padding: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); color: white; }
        .container-app { max-width: 600px; margin: auto; padding: 15px; }
        .search-card { background: var(--card); border-radius: var(--radius); padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .section-title { font-weight: 700; color: var(--primary); font-size: 16px; margin-bottom: 8px; margin-top: 15px; }
        .form-control, .form-select { border-radius: 12px; padding: 12px; border: 1px solid #ddd; background: #f8f9fa; }
        .form-control:focus { box-shadow: none; border-color: var(--primary); }
        
        .btn-main { background: var(--primary); color: white; border: none; border-radius: 12px; padding: 12px; font-weight: bold; width: 100%; margin-bottom: 10px; }
        .btn-main:hover { background: var(--secondary); color: white; }
        .btn-gold { background: var(--gold); color: #000; border: none; border-radius: 12px; padding: 12px; font-weight: bold; width: 100%; }
        .btn-outline { border: 2px solid var(--primary); color: var(--primary); background: white; border-radius: 12px; padding: 10px; font-weight: bold; width: 100%; transition: 0.3s; }
        .btn-outline:hover { background: var(--primary); color: white; }
        
        .btn-show-more { background: white; color: var(--primary); border: 2px dashed var(--primary); width: 100%; padding: 15px; border-radius: 12px; font-weight: bold; margin-top: 15px; transition: 0.3s; }
        .btn-show-more:hover { background: var(--primary); color: white; }

        .school-link { text-decoration: underline; cursor: pointer; font-weight: 700; transition: opacity 0.2s; }
        .school-link:hover { opacity: 0.8; }

        .whatsapp-card { background: #e7fceb; border: 1px solid #25D366; border-radius: 12px; padding: 12px; margin-top: 10px; cursor: pointer; transition: transform 0.2s; animation: fadeIn 0.5s; text-decoration: none; display: block; }
        .whatsapp-card:active { transform: scale(0.98); }

        .icon-circle { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-left: 12px; flex-shrink: 0; color: white; }
        .icon-whatsapp { background: #25D366; }

        .result-card-wrapper { margin-bottom: 20px; }
        .result-card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: relative; animation: fadeIn 0.3s; color: #333; }

        /* Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø­Ø³Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© */
        .card-admis { background: linear-gradient(135deg, #198754, #20c997); color: white !important; }
        .card-session { background: linear-gradient(135deg, #ffc107, #fd7e14); color: white !important; }
        .card-recale { background: linear-gradient(135deg, #dc3545, #b02a37); color: white !important; }

        .card-admis .text-muted, .card-session .text-muted, .card-recale .text-muted { color: rgba(255, 255, 255, 0.85) !important; }
        .card-admis .text-success, .card-session .text-success, .card-recale .text-success { color: #fff !important; }
        .card-admis .school-link, .card-session .school-link, .card-recale .school-link { color: #fff !important; }
        .card-admis .info-grid, .card-session .info-grid, .card-recale .info-grid { background-color: rgba(255, 255, 255, 0.15); border-color: rgba(255, 255, 255, 0.2); }
        .card-admis .info-label, .card-session .info-label, .card-recale .info-label { color: rgba(255, 255, 255, 0.9); }
        .card-admis .info-value, .card-session .info-value, .card-recale .info-value { color: #fff; }
        .card-admis .badge, .card-session .badge, .card-recale .badge { background-color: rgba(255, 255, 255, 0.2) !important; color: #fff !important; border: 1px solid rgba(255, 255, 255, 0.3) !important; }

        .rank-badge { position: absolute; top: 10px; left: 10px; background: var(--gold); color: #000; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 2; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; background-color: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 0.85rem; border: 1px solid #eee; }
        .info-item { display: flex; flex-direction: column; }
        .info-label { font-weight: bold; color: var(--primary); font-size: 0.75rem; }
        .info-value { color: #333; font-weight: 600; }

        #topPageOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 1000; overflow-y: auto; padding-bottom: 50px; display: none; }
        .top-header { background: white; padding: 15px; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }

        .selection-btn { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 10px; margin-bottom: 10px; text-align: center; font-weight: bold; color: #333; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: space-between; }
        .selection-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .selection-icon { color: var(--primary); font-size: 1.2rem; }
        .selection-btn:hover .selection-icon { color: white; }

        #celebrationOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; overflow: hidden; }
        .congrats-box { background: white; padding: 30px; border-radius: 20px; text-align: center; position: relative; z-index: 10000; animation: zoomIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); max-width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .congrats-title { font-size: 2rem; color: var(--primary); font-weight: 800; margin-bottom: 10px; }
        .congrats-text { font-size: 1.1rem; color: #555; margin-bottom: 20px; }
        .confetti-piece { position: absolute; font-size: 20px; top: -20px; animation: fall linear forwards; z-index: 9998; }

        @keyframes zoomIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes fall { to { transform: translateY(105vh) rotate(720deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        footer { background: #fff; padding: 20px 0; margin-top: 40px; border-top: 1px solid #eaeaea; }
        .dev-credit { font-size: 0.9rem; color: #6c757d; }
        .dev-name { color: var(--primary); font-weight: 700; text-decoration: none; transition: color 0.2s; }
        .dev-name:hover { color: var(--secondary); }

        /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„ --- */
        #simulatorOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 2000; overflow-y: auto; display: none; padding-bottom: 50px; }
        .sim-header { background: white; padding: 15px; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .subject-row { background: white; border-radius: 12px; padding: 12px; margin-bottom: 10px; border: 1px solid #eee; display: flex; align-items: center; justify-content: space-between; }
        .coeff-badge { background: #e9ecef; color: #555; padding: 4px 10px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; margin-right: 10px; }
        .grade-input { width: 70px; text-align: center; font-weight: bold; border: 2px solid #ddd; border-radius: 8px; padding: 5px; color: var(--primary); }
        .grade-input:focus { border-color: var(--primary); outline: none; }
        .total-card { background: linear-gradient(135deg, var(--secondary), var(--primary)); color: white; border-radius: 15px; padding: 20px; margin-top: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .final-score { font-size: 2.5rem; font-weight: 800; color: var(--gold); }

        /* Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª */
        #installBtn { display: none; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; transition: 0.3s; margin-right: auto; }
        #installBtn:hover { background: rgba(255,255,255,0.4); }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="container-app w-100 d-flex align-items-center justify-content-between">
            <span class="navbar-brand m-0 fw-bold fs-4"><i class="fas fa-graduation-cap me-2"></i>Resultat RIM</span>
            <!-- Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª -->
            <button id="installBtn"><i class="fas fa-download me-1"></i> ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
        </div>
    </nav>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ø­ØªÙØ§Ù„ -->
    <div id="celebrationOverlay">
        <div class="congrats-box">
            <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ‰ğŸŒºğŸ¥°</div>
            <div class="congrats-title">Ø£Ù„Ù Ø£Ù„Ù Ù…Ø¨Ø±ÙˆÙƒ!</div>
            <div class="congrats-text">
                ØªÙ‡Ø§Ù†ÙŠÙ†Ø§ Ø§Ù„Ø­Ø§Ø±Ø© Ø¨Ù…Ù†Ø§Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ ÙˆØªØ¬Ø§ÙˆØ² Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø¨Ø¬Ø¯Ø§Ø±Ø©.<br>
                Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ Ù…Ø³ÙŠØ±Ø© Ø¯Ø±Ø§Ø³ÙŠØ© Ù…Ù„ÙŠØ¦Ø© Ø¨Ø§Ù„ØªÙÙˆÙ‚.
            </div>
            <button class="btn btn-main" onclick="closeCelebration()">Ø´ÙƒØ±Ø§Ù‹ â¤ï¸</button>
        </div>
    </div>

    <div class="container-app">
        <div class="search-card mt-3">
            <h5 class="text-center fw-bold text-secondary mb-3">Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h5>
            
            <label class="section-title">Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©:</label>
            <select id="examType" class="form-select">
                <option value="concours" selected>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (ÙƒÙˆÙ†ÙƒÙˆØ±)</option>
                <option value="brevet">Ø®ØªÙ… Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ© (Ø¨Ø±ÙŠÙØ©)</option>
                <option value="bac_n">Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ - Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©</option>
                <option value="bac_c">Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ - Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„ØªÙƒÙ…ÙŠÙ„ÙŠØ©</option>
            </select>

            <label class="section-title">Ø§Ù„Ø¨Ø­Ø« Ø¨ÙˆØ§Ø³Ø·Ø©:</label>
            <div class="row g-2 mb-3">
                <div class="col-6">
                    <select id="searchCategory" class="form-select">
                        <option value="number">Ø±Ù‚Ù… Ø§Ù„Ù…ØªØ±Ø´Ø­</option>
                        <option value="school">Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</option>
                    </select>
                </div>
                <div class="col-6">
                    <input id="searchInput" type="text" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§...">
                </div>
            </div>

            <button id="searchBtn" class="btn-main"><i class="fas fa-search me-2"></i>Ø¨Ø­Ø«</button>
            <button onclick="openTopPage()" class="btn-gold"><i class="fas fa-chart-bar me-2"></i>Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ø£ÙˆØ§Ø¦Ù„</button>
            
            <!-- Ø²Ø± Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„ -->
            <button onclick="openSimulator()" class="btn-outline mt-2">
                <i class="fas fa-calculator me-2"></i>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„ (Simulateur)
            </button>
        </div>

        <div id="loading" class="text-center d-none mt-4">
            <div class="spinner-border text-success"></div>
            <p class="mt-2 text-muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>

        <div id="resultsContainer" class="mt-4"></div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„ -->
    <div id="simulatorOverlay">
        <div class="sim-header">
            <h5 class="m-0 fw-bold text-success"><i class="fas fa-calculator me-2"></i>Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„</h5>
            <button onclick="closeSimulator()" class="btn btn-sm btn-secondary"><i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
        
        <div class="container-app pt-3">
            <label class="section-title">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©:</label>
            <select id="simType" class="form-select mb-3" onchange="renderSimulatorInputs()">
                <option value="brevet">Ø®ØªÙ… Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ÙŠØ© (Brevet)</option>
                <option value="bac_sn">Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ - Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ© (SN)</option>
                <option value="bac_m">Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ - Ø±ÙŠØ§Ø¶ÙŠØ§Øª (M)</option>
                <option value="bac_lm">Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ - Ø¢Ø¯Ø§Ø¨ Ø¹ØµØ±ÙŠØ© (LM)</option>
                <option value="bac_lo">Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ - Ø¢Ø¯Ø§Ø¨ Ø£ØµÙ„ÙŠØ© (LO)</option>
                <option value="bac_tm">Ø¨Ø§ÙƒØ§Ù„ÙˆØ±ÙŠØ§ - ØªÙ‚Ù†ÙŠØ© (TM)</option>
            </select>

            <div id="simInputsContainer">
                <!-- Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ø¯ Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
            </div>

            <div class="total-card">
                <div class="small opacity-75">Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ</div>
                <div id="simResult" class="final-score">00.00</div>
                <div class="d-flex justify-content-center gap-3 mt-2 small">
                    <span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: <b id="simTotalPoints">0</b></span>
                    <span>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¶ÙˆØ§Ø±Ø¨: <b id="simTotalCoef">0</b></span>
                </div>
            </div>
            
            <div class="alert alert-info small mt-3">
                <i class="fas fa-info-circle me-1"></i> Ø§Ù„Ø­Ø³Ø§Ø¨ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¶ÙˆØ§Ø±Ø¨ Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù„Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø§Ù„ÙˆØ·Ù†ÙŠØ©.
            </div>
        </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„ -->
    <div id="topPageOverlay">
        <div class="top-header">
            <div class="d-flex align-items-center">
                <button id="backBtn" onclick="resetTopView()" class="btn btn-sm btn-outline-secondary me-2 d-none"><i class="fas fa-arrow-right"></i></button>
                <h5 class="m-0 fw-bold text-success"><i class="fas fa-crown me-2"></i>Ù„ÙˆØ­Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„</h5>
            </div>
            <button onclick="closeTopPage()" class="btn btn-sm btn-secondary"><i class="fas fa-times"></i> Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
        
        <div class="container-app">
            <div id="topMenu">
                <div class="alert alert-info small mb-3">
                    <i class="fas fa-info-circle me-1"></i> Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ø±Ø¤ÙŠØ© Ø§Ù„Ù…ØªÙÙˆÙ‚ÙŠÙ†.
                </div>

                <button class="btn-main" onclick="loadNationalTop()">
                    <i class="fas fa-globe-africa me-2"></i>Ø§Ù„Ù€ 20 Ø§Ù„Ø£ÙˆØ§Ø¦Ù„ ÙˆØ·Ù†ÙŠØ§Ù‹
                </button>

                <div class="row g-2 mt-2">
                    <div class="col-6" id="stateBtnCol">
                        <button class="btn-outline" onclick="renderGroupList('wilaya')">
                            <i class="fas fa-map-marker-alt me-1"></i> Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©
                        </button>
                    </div>
                    <div class="col-6" id="majorBtnCol">
                        <button class="btn-outline" onclick="renderGroupList('major')">
                            <i class="fas fa-book me-1"></i> Ø­Ø³Ø¨ Ø§Ù„Ø´Ø¹Ø¨Ø©
                        </button>
                    </div>
                </div>
            </div>

            <div id="selectionListContainer" class="mt-4 d-none">
                <h6 id="selectionTitle" class="fw-bold text-secondary mb-3"></h6>
                <div id="selectionItems" class="row g-2"></div>
            </div>

            <div id="topPageResults" class="mt-4"></div>
        </div>
    </div>

    <footer class="text-center">
        <div class="container">
            <p class="dev-credit mb-1">Designed & Developed by</p>
            <a href="#" class="dev-name mb-2 d-block">Mohamed Dah Agove</a>
            <div style="font-size: 0.75rem; color: #999;">&copy; 2026 Resultat RIM. All rights reserved.</div>
        </div>
    </footer>

    <script>
        // ØªØ³Ø¬ÙŠÙ„ Service Worker Ù„Ø¬Ø¹Ù„Ù‡ PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered!', reg))
                    .catch(err => console.log('SW Registration Failed!', err));
            });
        }

        // Ù…Ù†Ø·Ù‚ Ø²Ø± Ø§Ù„ØªØ«Ø¨ÙŠØª
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'block';
        });

        installBtn.addEventListener('click', () => {
            installBtn.style.display = 'none';
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                });
            }
        });

        // *** Ø±Ø§Ø¨Ø· Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ "ØªÙˆØ¬ÙŠÙ‡ ÙˆØªØ®ØµØµØ§Øª" ***
        const orientationGroupLink = "https://www.unem2000.com/whatsapp"; 

        // ==============================================
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª
        // ==============================================
        const examConfig = {
            "bac_n": {
                file: "bac_n.csv", 
                searchKeys: ["NODOSS", "Num", "NÂ°"], 
                nameKeys: ["NOM_AR", "Nom", "Nom complet"], 
                scoreKeys: ["Moy Bac", "Moyenne", "Moyenne_Bac", "Moy"], 
                placeKeys: ["Etablissement_AR", "Etablissement", "Centre", "Lieu"], 
                decisionKeys: ["Decision", "Resultat"],
                stateKeys: ["Wilaya_AR", "Wilaya", "DREN", "Wilaya_FR"], majorKeys: ["SERIE", "Serie", "Option"]
            },
            "bac_c": {
                file: "bac_c.csv",
                searchKeys: ["NODOSS", "Num"], 
                nameKeys: ["NOM_AR", "Nom"], 
                scoreKeys: ["Moy Bac_Session", "Moy Bac", "Moyenne"], 
                placeKeys: ["Etablissement_AR", "Etablissement"], decisionKeys: ["Decision"],
                stateKeys: ["Wilaya_AR", "Wilaya", "DREN"], majorKeys: ["SERIE", "Serie"]
            },
            "brevet": {
                file: "brevet.csv",
                searchKeys: ["Num_Bepc", "Num"], nameKeys: ["NOM", "Nom"], scoreKeys: ["Moyenne_Bepc", "Moyenne"],
                placeKeys: ["Ecole", "Etablissement", "Centre", "Lieu"], decisionKeys: ["Decision"], 
                stateKeys: ["WILAYA", "Wilaya", "Wilaya_AR"], majorKeys: []
            },
            "concours": {
                file: "concours.csv",
                searchKeys: ["Noreg", "NumÃ©ro_C1AS", "NODOSS", "Num"], nameKeys: ["NOM_AR", "Nom"], 
                scoreKeys: ["TOTAL", "Totale", "Score"],
                placeKeys: ["Ecole_AR", "Ecole", "Centre Examen_AR"], decisionKeys: [], 
                stateKeys: ["WILAYA_AR", "Wilaya_AR", "WILAYA"], majorKeys: []
            }
        };

        const staticMajors = [
            { label: "Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© (SN)", searchVal: ["SN"] },
            { label: "Ø§Ù„Ø¢Ø¯Ø§Ø¨ Ø§Ù„Ø£ØµÙ„ÙŠØ© (LO)", searchVal: ["LO"] },
            { label: "Ø§Ù„Ø¢Ø¯Ø§Ø¨ Ø§Ù„Ø¹ØµØ±ÙŠØ© (LM)", searchVal: ["LM"] },
            { label: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª (M)", searchVal: ["M", "C"] },
            { label: "Ø§Ù„ØªÙ‚Ù†ÙŠØ© (TM)", searchVal: ["TM", "T"] },
            { label: "Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ© (TS)", searchVal: ["TS"] },
            { label: "Ø§Ù„Ù„ØºØ§Øª (LA)", searchVal: ["LA"] }
        ];

        const staticWilayas = [
            { label: "Ø§Ù„Ø­ÙˆØ¶ Ø§Ù„Ø´Ø±Ù‚ÙŠ", searchVal: ["Ø§Ù„Ø­ÙˆØ¶ Ø§Ù„Ø´Ø±Ù‚ÙŠ", "Hod Charghi"] },
            { label: "Ø§Ù„Ø­ÙˆØ¶ Ø§Ù„ØºØ±Ø¨ÙŠ", searchVal: ["Ø§Ù„Ø­ÙˆØ¶ Ø§Ù„ØºØ±Ø¨ÙŠ", "Hod Gharbi"] },
            { label: "Ù„Ø¹ØµØ§Ø¨Ù‡", searchVal: ["Ù„Ø¹ØµØ§Ø¨Ù‡", "Ù„Ø¹ØµØ§Ø¨Ø©", "ASSABA"] },
            { label: "ÙƒÙˆØ±ÙƒÙ„", searchVal: ["ÙƒÙˆØ±ÙƒÙ„", "GORGOL"] },
            { label: "Ù„Ø¨Ø±Ø§ÙƒÙ†Ù‡", searchVal: ["Ù„Ø¨Ø±Ø§ÙƒÙ†Ù‡", "BRAKNA"] },
            { label: "Ø§ØªØ±Ø§Ø±Ø²Ù‡", searchVal: ["Ø§ØªØ±Ø§Ø±Ø²Ù‡", "TRARZA"] },
            { label: "Ø¢Ø¯Ø±Ø§Ø±", searchVal: ["Ø¢Ø¯Ø±Ø§Ø±", "ADRAR", "Ø§Ø¯Ø±Ø§Ø±"] },
            { label: "Ø¯Ø§Ø®Ù„Øª Ø§Ù†ÙˆØ§Ø°ÙŠØ¨Ùˆ", searchVal: ["Ø¯Ø§Ø®Ù„Øª Ø§Ù†ÙˆØ§Ø°ÙŠØ¨Ùˆ", "NOUADHIBOU", "Ø¯Ø§Ø®Ù„Øª Ø§Ù†ÙˆØ§Ø°ÙŠØ¨"] },
            { label: "ØªÙƒØ§Ù†Øª", searchVal: ["ØªÙƒØ§Ù†Øª", "TAGANT"] },
            { label: "ÙƒÙŠØ¯ÙŠÙ…Ø§ØºØ§", searchVal: ["ÙƒÙŠØ¯ÙŠÙ…Ø§ØºØ§", "GUIDIMAGHA", "ÙƒÙŠØ¯ÙŠ Ù…Ø§ØºÙ‡"] },
            { label: "ØªÙŠØ±Ø³ Ø²Ù…ÙˆØ±", searchVal: ["ØªÙŠØ±Ø³ Ø²Ù…ÙˆØ±", "TIRIS ZEMMOUR", "ØªÙŠØ±Ø³ Ø§Ø²Ù…ÙˆØ±", "Tiris Zemour", "Zemour"] },
            { label: "Ø§ÙŠÙ†Ø´ÙŠØ±ÙŠ", searchVal: ["Ø§ÙŠÙ†Ø´ÙŠØ±ÙŠ", "INCHIRI"] },
            { label: "Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· 1 (Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©)", searchVal: ["Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©", "NKTT NORD", "NORD", "Nouakchott Nord"] },
            { label: "Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· 2 (Ø§Ù„ØºØ±Ø¨ÙŠØ©)", searchVal: ["Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· Ø§Ù„ØºØ±Ø¨ÙŠØ©", "Nouakchott Ouest", "NKTT OUEST"] },
            { label: "Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· 3 (Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠØ©)", searchVal: ["Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠØ©", "NKTT SUD", "SUD", "Nouakchott Sud"] }
        ];

        // ==============================================
        // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        // ==============================================
        const examSelect = document.getElementById('examType');
        const categorySelect = document.getElementById('searchCategory');

        function updateSearchCategory() {
            if (examSelect.value === 'concours') {
                categorySelect.value = 'school';
            } else {
                categorySelect.value = 'number';
            }
        }

        examSelect.addEventListener('change', updateSearchCategory);
        document.addEventListener('DOMContentLoaded', updateSearchCategory);

        // ==============================================
        // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ
        // ==============================================

        let cache = {}; 

        // Ù…ØªØºÙŠØ±Ø§Øª Ù„Ø¥Ø¯Ø§Ø±Ø© "Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯"
        let currentFilteredResults = [];
        let currentRenderCount = 0;
        let currentBatchSize = 100;
        let currentSearchConfig = null;
        let currentSearchExamType = null;
        let currentSearchMode = 'school';

        function getVal(item, keysArray) {
            if (!item || !keysArray) return "";
            for (let key of keysArray) {
                if (item[key] !== undefined && item[key] !== null) return item[key];
            }
            return ""; 
        }

        function parseScore(val) {
            if (!val) return 0;
            let clean = String(val).trim().replace(/[^0-9.,]/g, '').replace(',', '.');
            let num = parseFloat(clean);
            return isNaN(num) ? 0 : num;
        }

        function getNormalizedState(rawState) {
            if (!rawState) return "unknown";
            let text = String(rawState).trim().toLowerCase().replace(/\s+/g, ' ');

            if ((text.includes('nouakchott') || text.includes('nktt')) && text.includes('ouest')) {
                return "Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· 2 (Ø§Ù„ØºØ±Ø¨ÙŠØ©)";
            }
            if (text.includes('Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ·') && text.includes('Ø§Ù„ØºØ±Ø¨ÙŠØ©')) {
                return "Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· 2 (Ø§Ù„ØºØ±Ø¨ÙŠØ©)";
            }
            if ((text.includes('nouakchott') || text.includes('nktt')) && text.includes('nord')) {
                return "Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· 1 (Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©)";
            }
            if (text.includes('Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ·') && text.includes('Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©')) {
                return "Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· 1 (Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©)";
            }
            if ((text.includes('nouakchott') || text.includes('nktt')) && text.includes('sud')) {
                return "Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· 3 (Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠØ©)";
            }
            if (text.includes('Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ·') && text.includes('Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠØ©')) {
                return "Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ· 3 (Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠØ©)";
            }

            for (let group of staticWilayas) {
                if(group.label.includes("Ø§Ù†ÙˆØ§ÙƒØ´ÙˆØ·")) continue; 
                if (group.searchVal.some(term => text.includes(term.toLowerCase()))) {
                    return group.label;
                }
            }
            return text; 
        }

        const emojis = ['ğŸŒ¸', 'ğŸŒ¹', 'ğŸ’', 'â¤ï¸', 'ğŸ‰', 'ğŸŠ', 'ğŸŒ·', 'âœ¨', 'ğŸ’•', 'ğŸ¥°'];
        let celebrationInterval;

        function createConfetti() {
            const overlay = document.getElementById('celebrationOverlay');
            if(overlay.style.display === 'none') return;
            const el = document.createElement('div');
            el.classList.add('confetti-piece');
            el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
            el.style.left = Math.random() * 100 + 'vw';
            el.style.animationDuration = (Math.random() * 3 + 2) + 's';
            el.style.fontSize = (Math.random() * 20 + 20) + 'px';
            overlay.appendChild(el);
            setTimeout(() => { el.remove(); }, 5000);
        }

        function triggerCelebration() {
            const overlay = document.getElementById('celebrationOverlay');
            overlay.style.display = 'flex';
            if(celebrationInterval) clearInterval(celebrationInterval);
            celebrationInterval = setInterval(createConfetti, 100);
        }

        function closeCelebration() {
            document.getElementById('celebrationOverlay').style.display = 'none';
            if(celebrationInterval) clearInterval(celebrationInterval);
            document.querySelectorAll('.confetti-piece').forEach(e => e.remove());
        }

        function isResultSuccessful(student, config) {
            const decisionRaw = getVal(student, config.decisionKeys);
            if (!decisionRaw) return false;
            let d = String(decisionRaw).toLowerCase();
            return d.includes('admis') || d.includes('Ù†Ø§Ø¬Ø­');
        }

        function searchBySchoolName(schoolName) {
            document.getElementById('topPageOverlay').style.display = 'none';
            document.getElementById('searchCategory').value = 'school';
            document.getElementById('searchInput').value = schoolName;
            document.querySelector('.container-app').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('searchBtn').click();
        }

        // ==============================================
        // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø³Ø¨Ù‚Ø©
        // ==============================================
        
        function preprocessData(data, config, examType) {
            data.sort((a, b) => parseScore(getVal(b, config.scoreKeys)) - parseScore(getVal(a, config.scoreKeys)));

            let stateCounters = {};
            let schoolCounters = {};
            let serieCounters = {};
            
            data.forEach((student, index) => {
                student._score = parseScore(getVal(student, config.scoreKeys));
                student._nationalRank = index + 1;

                let stateRaw = getVal(student, config.stateKeys);
                let stateNorm = getNormalizedState(stateRaw);
                student._stateNorm = stateNorm; 
                
                if (stateNorm !== 'unknown') {
                    if (!stateCounters[stateNorm]) stateCounters[stateNorm] = 0;
                    stateCounters[stateNorm]++;
                    student._stateRank = stateCounters[stateNorm];
                }

                let school = getVal(student, config.placeKeys).trim();
                if (school) {
                    if (!schoolCounters[school]) schoolCounters[school] = 0;
                    schoolCounters[school]++;
                    student._schoolRank = schoolCounters[school];
                }

                if (examType.includes('bac')) {
                    let serie = getVal(student, config.majorKeys);
                    if (serie) {
                        if (!serieCounters[serie]) serieCounters[serie] = 0;
                        serieCounters[serie]++;
                        student._serieRank = serieCounters[serie];
                        student._serie = serie;
                    }
                }
            });

            return data;
        }

        async function fetchData(examType) {
            if (cache[examType]) return cache[examType];
            const config = examConfig[examType];
            try {
                const response = await fetch(config.file);
                if (!response.ok) throw new Error(`Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
                const csvText = await response.text();
                const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true, transformHeader: h => h.trim() });
                
                if(parsed.data.length === 0) throw new Error("Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº");
                
                const processedData = preprocessData(parsed.data, config, examType);
                
                cache[examType] = processedData;
                return processedData;
            } catch (error) { throw error; }
        }

        document.getElementById('searchBtn').addEventListener('click', async () => {
            const examType = document.getElementById('examType').value;
            const searchCat = document.getElementById('searchCategory').value;
            const inputVal = document.getElementById('searchInput').value.trim().toLowerCase();
            const config = examConfig[examType];
            
            if (!inputVal) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ù„Ù„Ø¨Ø­Ø«");

            const container = document.getElementById('resultsContainer');
            const loading = document.getElementById('loading');
            
            container.innerHTML = '';
            loading.classList.remove('d-none');

            setTimeout(async () => {
                try {
                    const data = await fetchData(examType);
                    let results = [];

                    if (searchCat === 'number') {
                        results = data.filter(item => String(getVal(item, config.searchKeys)).trim().toLowerCase() === inputVal);
                    } else {
                        results = data.filter(item => String(getVal(item, config.placeKeys)).toLowerCase().includes(inputVal));
                    }

                    loading.classList.add('d-none');
                    
                    if (results.length === 0) {
                        container.innerHTML = '<div class="alert alert-warning text-center">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†ØªØ§Ø¦Ø¬.</div>';
                        return;
                    }

                    container.innerHTML = `<div class="alert alert-success text-center fw-bold">ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${results.length} Ù†ØªÙŠØ¬Ø©</div>`;

                    currentFilteredResults = results;
                    currentRenderCount = 0;
                    currentSearchConfig = config;
                    currentSearchExamType = examType;
                    currentSearchMode = searchCat; 
                    
                    renderNextBatch();

                    setTimeout(() => {
                        const firstResult = document.querySelector('.result-card-wrapper');
                        if (firstResult) {
                            firstResult.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 100);

                    if (searchCat === 'number' && results.length > 0) {
                        const winner = results.find(s => isResultSuccessful(s, config));
                        if (winner) triggerCelebration();
                    }

                } catch (error) {
                    loading.classList.add('d-none');
                    alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message);
                }
            }, 50);
        });

        // ==============================================
        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙØ¹Ø§Øª
        // ==============================================
        function renderNextBatch() {
            const container = document.getElementById('resultsContainer');
            
            const oldBtn = document.getElementById('showMoreBtn');
            if(oldBtn) oldBtn.remove();

            const nextLimit = Math.min(currentRenderCount + currentBatchSize, currentFilteredResults.length);

            for (let i = currentRenderCount; i < nextLimit; i++) {
                renderCard(currentFilteredResults[i], currentSearchConfig, container, null, currentSearchExamType, currentSearchMode);
            }

            currentRenderCount = nextLimit;

            if (currentRenderCount < currentFilteredResults.length) {
                const remaining = currentFilteredResults.length - currentRenderCount;
                const nextCount = Math.min(currentBatchSize, remaining);
                container.innerHTML += `<button id="showMoreBtn" class="btn-show-more" onclick="renderNextBatch()">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ (${nextCount}) <i class="fas fa-chevron-down"></i></button>`;
            }
        }

        // ==============================================
        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
        // ==============================================
        function openTopPage() { 
            resetTopView(); 
            const examType = document.getElementById('examType').value;
            const majorBtnCol = document.getElementById('majorBtnCol');
            const stateBtnCol = document.getElementById('stateBtnCol');

            majorBtnCol.style.display = 'none';
            stateBtnCol.style.display = 'none';

            if (examType.includes('bac')) {
                majorBtnCol.style.display = 'block';
                stateBtnCol.style.display = 'block';
                stateBtnCol.className = 'col-6';
            } else if (examType === 'brevet') {
                stateBtnCol.style.display = 'block';
                stateBtnCol.className = 'col-12';
            }
            
            document.getElementById('topPageOverlay').style.display = 'block'; 
        }

        function closeTopPage() { document.getElementById('topPageOverlay').style.display = 'none'; }

        function resetTopView() {
            document.getElementById('topMenu').classList.remove('d-none');
            document.getElementById('selectionListContainer').classList.add('d-none');
            document.getElementById('topPageResults').innerHTML = '';
            document.getElementById('backBtn').classList.add('d-none');
        }

        async function loadNationalTop() {
            document.getElementById('topMenu').classList.add('d-none');
            document.getElementById('backBtn').classList.remove('d-none');
            const examType = document.getElementById('examType').value;
            const config = examConfig[examType];
            const container = document.getElementById('topPageResults');
            container.innerHTML = '<div class="text-center"><div class="spinner-border text-success"></div></div>';
            try {
                const data = await fetchData(examType);
                container.innerHTML = '<h6 class="text-center fw-bold text-success mb-3">Ø£Ø¹Ù„Ù‰ 20 Ù…Ø¹Ø¯Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ÙˆØ·Ù†ÙŠ</h6>';
                data.slice(0, 20).forEach((student, index) => {
                    renderCard(student, config, container, index + 1, examType, 'top');
                });
            } catch (e) { container.innerHTML = `<div class="alert alert-danger">Ø®Ø·Ø£: ${e.message}</div>`; }
        }

        function renderGroupList(groupBy) {
            document.getElementById('topMenu').classList.add('d-none');
            document.getElementById('backBtn').classList.remove('d-none');
            const listContainer = document.getElementById('selectionListContainer');
            const itemsDiv = document.getElementById('selectionItems');
            document.getElementById('selectionTitle').innerText = groupBy === 'wilaya' ? 'Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ©:' : 'Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©:';
            
            listContainer.classList.remove('d-none');
            itemsDiv.innerHTML = '';
            
            let items = groupBy === 'wilaya' ? staticWilayas : staticMajors;
            items.forEach(item => {
                let col = document.createElement('div');
                col.className = 'col-12'; 
                col.innerHTML = `<div class="selection-btn"><span>${item.label}</span><i class="fas fa-chevron-left selection-icon"></i></div>`;
                col.onclick = () => loadTopTenForGroup(groupBy, item.searchVal, item.label);
                itemsDiv.appendChild(col);
            });
        }

        async function loadTopTenForGroup(groupBy, searchTerms, label) {
            document.getElementById('selectionListContainer').classList.add('d-none');
            const container = document.getElementById('topPageResults');
            container.innerHTML = '<div class="text-center"><div class="spinner-border text-success"></div></div>';
            const examType = document.getElementById('examType').value;
            const config = examConfig[examType];
            let targetKeys = groupBy === 'wilaya' ? config.stateKeys : config.majorKeys;

            try {
                const data = await fetchData(examType);
                let filtered = data.filter(item => {
                    let val = String(getVal(item, targetKeys)).trim();
                    if (groupBy === 'wilaya') {
                         const studentNormalized = getNormalizedState(val);
                         return studentNormalized === label; 
                    } else {
                        return searchTerms.some(term => val.toLowerCase() === term.toLowerCase() || val.includes(term));
                    }
                });
                
                filtered.sort((a, b) => parseScore(getVal(b, config.scoreKeys)) - parseScore(getVal(a, config.scoreKeys)));
                
                container.innerHTML = `<h6 class="text-center fw-bold text-primary mb-3">Ø§Ù„Ø¹Ø´Ø±Ø© Ø§Ù„Ø£ÙˆØ§Ø¦Ù„: ${label}</h6>`;
                if(filtered.length === 0) container.innerHTML += '<div class="alert alert-warning text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</div>';
                else {
                    filtered.slice(0, 10).forEach((student, index) => {
                        renderCard(student, config, container, index + 1, examType, 'top');
                    });
                }
            } catch (e) { container.innerHTML = `<div class="alert alert-danger">Ø®Ø·Ø£: ${e.message}</div>`; }
        }

        // ==============================================
        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø±Ø¶ (Ù…Ø­Ø¯Ø«Ø© Ø¨Ø§Ù„Ø£Ù„ÙˆØ§Ù† ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„)
        // ==============================================
        function renderCard(student, config, targetElement, rank = null, examType = '', searchMode = '') {
            const name = getVal(student, config.nameKeys) || 'Ø§Ø³Ù… ØºÙŠØ± Ù…ØªÙˆÙØ±';
            const number = getVal(student, config.searchKeys);
            const score = student._score; 
            const place = getVal(student, config.placeKeys);
            const decisionRaw = getVal(student, config.decisionKeys);
            
            let state = student._stateNorm;
            if(state === "unknown") state = getVal(student, config.stateKeys);

            let isAdmis = false;
            let decisionHtml = '';
            
            // Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆØ§Ù„Ø±Ø³Ø§Ù„Ø©
            let cardClass = '';
            let encouragementMsg = '';

            if (decisionRaw) {
                let d = String(decisionRaw).toLowerCase();
                
                if (d.includes('admis') || d.includes('Ù†Ø§Ø¬Ø­')) {
                    decisionHtml = `<span class="badge bg-white text-success border border-white">${decisionRaw}</span>`;
                    isAdmis = true;
                    cardClass = 'card-admis'; // Ù„ÙˆÙ† Ø£Ø®Ø¶Ø±
                } else if (d.includes('session') || d.includes('Ù…Ø¤Ø¬Ù„')) {
                    decisionHtml = `<span class="badge bg-white text-warning border border-white">${decisionRaw}</span>`;
                    cardClass = 'card-session'; // Ù„ÙˆÙ† Ø£ØµÙØ±/Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
                } else {
                    decisionHtml = `<span class="badge bg-white text-danger border border-white">${decisionRaw}</span>`;
                    cardClass = 'card-recale'; // Ù„ÙˆÙ† Ø£Ø­Ù…Ø±
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ´Ø¬ÙŠØ¹ÙŠØ©
                    encouragementMsg = `
                        <div class="mt-2 text-center p-2 rounded" style="background: rgba(255,255,255,0.2); border: 1px dashed rgba(255,255,255,0.5);">
                            <span class="small fw-bold text-white"><i class="fas fa-heart me-1"></i> ÙÙŠÙ‡ Ø®ÙŠØ± Ù„Ø§ ØªÙŠØ£Ø³ ÙˆØ§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ğŸ’ª</span>
                        </div>
                    `;
                }
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø± (Ù…Ø«Ù„ ÙƒÙˆÙ†ÙƒÙˆØ± Ø£Ø­ÙŠØ§Ù†Ø§Ù‹)
                cardClass = ''; 
            }

            let rankBadge = rank ? `<div class="rank-badge">${rank}</div>` : '';
            let extraStyle = rank ? 'padding-left: 50px;' : '';

            let gridHtml = '';
            let items = [];
            
            if(student._serie) items.push({l: 'Ø§Ù„Ø´Ø¹Ø¨Ø©', v: student._serie});
            if(student._serieRank) items.push({l: 'Ø§Ù„Ø±ØªØ¨Ø© ÙÙŠ Ø§Ù„Ø´Ø¹Ø¨Ø©', v: student._serieRank});
            if(student._nationalRank) items.push({l: 'Ø§Ù„Ø±ØªØ¨Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ©', v: student._nationalRank});
            if(student._stateRank) items.push({l: 'Ø§Ù„Ø±ØªØ¨Ø© ÙÙŠ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©', v: student._stateRank});
            if(student._schoolRank) items.push({l: 'Ø§Ù„Ø±ØªØ¨Ø© ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ²', v: student._schoolRank});

            if (items.length > 0) {
                gridHtml = `<div class="info-grid">`;
                items.forEach(item => {
                    gridHtml += `<div class="info-item"><span class="info-label">${item.l}</span><span class="info-value">${item.v}</span></div>`;
                });
                gridHtml += `</div>`;
            }

            // --- Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ---
            let whatsappActions = '';

            if (isAdmis && searchMode === 'number') {
                if (examType === 'bac_n' || examType === 'bac_c') {
                     whatsappActions += `
                    <a href="${orientationGroupLink}" target="_blank" class="whatsapp-card">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle icon-whatsapp"><i class="fas fa-university"></i></div>
                            <div>
                                <h6 class="fw-bold mb-1" style="color:#0f5132">ğŸ“ ØªÙˆØ¬ÙŠÙ‡ ÙˆØªØ®ØµØµØ§Øª</h6>
                                <p class="m-0 small text-secondary">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø´Ø±Ø­ Ø§Ù„ØªØ®ØµØµØ§Øª.</p>
                            </div>
                        </div>
                    </a>`;
                }
            }

            const safePlace = place.replace(/'/g, "\\'");

            targetElement.innerHTML += `
                <div class="result-card-wrapper">
                    <div class="result-card ${cardClass}">
                        ${rankBadge}
                        <div style="${extraStyle}">
                            <h6 class="fw-bold mb-1">${name}</h6>
                            <div class="small text-muted row">
                                <div class="col-6">Ø±Ù‚Ù…: <b>${number}</b></div>
                                <div class="col-6 text-end">Ø§Ù„Ù…Ø¹Ø¯Ù„: <b class="text-success">${score % 1 !== 0 ? score.toFixed(2) : score}</b></div>
                            </div>
                            <div class="small text-muted mt-1">
                                <i class="fas fa-school me-1"></i> 
                                <span class="school-link" onclick="searchBySchoolName('${safePlace}')">${place}</span>
                            </div>
                            
                            ${gridHtml}

                            <div class="mt-2 d-flex justify-content-between align-items-center">
                                ${decisionHtml}
                                ${state ? `<span class="badge bg-light text-dark border">${state}</span>` : ''}
                            </div>
                            
                            ${encouragementMsg}
                        </div>
                    </div>
                    ${whatsappActions}
                </div>`;
        }

        // ==============================================
        // Ù…Ù†Ø·Ù‚ Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„ (Simulateur)
        // ==============================================

        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¶ÙˆØ§Ø±Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ Ø§Ù„Ù…ÙˆØ±ÙŠØªØ§Ù†ÙŠ
        const simData = {
            "brevet": [
                { name: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", coef: 5 },
                { name: "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", coef: 3 },
                { name: "Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©", coef: 2 },
                { name: "Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©", coef: 2 },
                { name: "Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ ÙˆØ§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡", coef: 2 },
                { name: "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", coef: 2 },
                { name: "Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", coef: 1 },
                { name: "Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§", coef: 1 },
                { name: "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ù…Ø¯Ù†ÙŠØ©", coef: 1 },
                { name: "Ø§Ù„Ø±ÙŠØ§Ø¶Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ©", coef: 1 }
            ],
            "bac_sn": [ // Ø¹Ù„ÙˆÙ… Ø·Ø¨ÙŠØ¹ÙŠØ© D
                { name: "Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©", coef: 8 },
                { name: "Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ ÙˆØ§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡", coef: 7 },
                { name: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", coef: 6 },
                { name: "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", coef: 3 },
                { name: "Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©", coef: 3 },
                { name: "Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", coef: 2 },
                { name: "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", coef: 2 },
                { name: "Ø§Ù„Ø±ÙŠØ§Ø¶Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ©", coef: 1 }
            ],
            "bac_m": [ // Ø±ÙŠØ§Ø¶ÙŠØ§Øª C
                { name: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", coef: 9 },
                { name: "Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ ÙˆØ§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡", coef: 8 },
                { name: "Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ©", coef: 4 },
                { name: "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", coef: 3 },
                { name: "Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©", coef: 3 },
                { name: "Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", coef: 2 },
                { name: "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", coef: 2 },
                { name: "Ø§Ù„Ø±ÙŠØ§Ø¶Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ©", coef: 1 }
            ],
            "bac_lm": [ // Ø¢Ø¯Ø§Ø¨ Ø¹ØµØ±ÙŠØ© LM
                { name: "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", coef: 6 },
                { name: "Ø§Ù„ÙÙ„Ø³ÙØ©", coef: 6 },
                { name: "Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©", coef: 6 },
                { name: "Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§", coef: 5 },
                { name: "Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", coef: 4 },
                { name: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", coef: 2 },
                { name: "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", coef: 2 },
                { name: "Ø§Ù„Ø±ÙŠØ§Ø¶Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ©", coef: 1 }
            ],
            "bac_lo": [ // Ø¢Ø¯Ø§Ø¨ Ø£ØµÙ„ÙŠØ© LO
                { name: "Ø§Ù„ØªØ´Ø±ÙŠØ¹ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ", coef: 7 },
                { name: "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", coef: 7 },
                { name: "Ø§Ù„ÙÙƒØ± Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ", coef: 6 },
                { name: "Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§", coef: 4 },
                { name: "Ø§Ù„Ù‚Ø±Ø¢Ù† ÙˆØ§Ù„Ø­Ø¯ÙŠØ«", coef: 3 },
                { name: "Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©", coef: 2 },
                { name: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", coef: 2 },
                { name: "Ø§Ù„Ø±ÙŠØ§Ø¶Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ©", coef: 1 }
            ],
            "bac_tm": [ // ØªÙ‚Ù†ÙŠØ© TM
                { name: "Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©/Ø§Ù„Ø±Ø³Ù… Ø§Ù„ØªÙ‚Ù†ÙŠ", coef: 7 },
                { name: "Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª/Ø§Ù„ØªØ®ØµØµ", coef: 6 },
                { name: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", coef: 4 },
                { name: "Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ ÙˆØ§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡", coef: 3 },
                { name: "Ø§Ù„ÙˆØ±Ø´Ø© (Atelier)", coef: 3 },
                { name: "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", coef: 2 },
                { name: "Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©", coef: 2 },
                { name: "Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©", coef: 2 },
                { name: "Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", coef: 1 },
                { name: "Ø§Ù„Ø±ÙŠØ§Ø¶Ø© Ø§Ù„Ø¨Ø¯Ù†ÙŠØ©", coef: 1 }
            ]
        };

        function openSimulator() {
            document.getElementById('simulatorOverlay').style.display = 'block';
            renderSimulatorInputs();
        }

        function closeSimulator() {
            document.getElementById('simulatorOverlay').style.display = 'none';
        }

        function renderSimulatorInputs() {
            const type = document.getElementById('simType').value;
            const container = document.getElementById('simInputsContainer');
            const subjects = simData[type];
            
            container.innerHTML = '';
            
            subjects.forEach((sub, idx) => {
                container.innerHTML += `
                    <div class="subject-row">
                        <div class="d-flex align-items-center">
                            <span class="coeff-badge">Ø¶: ${sub.coef}</span>
                            <span class="fw-bold text-secondary" style="font-size: 0.9rem;">${sub.name}</span>
                        </div>
                        <input type="number" inputmode="decimal" class="grade-input" 
                            placeholder="0" min="0" max="20" data-coef="${sub.coef}" 
                            oninput="calculateSimScore()">
                    </div>
                `;
            });
            calculateSimScore();
        }

        function calculateSimScore() {
            const inputs = document.querySelectorAll('.grade-input');
            let totalPoints = 0;
            let totalCoef = 0;

            inputs.forEach(input => {
                let val = parseFloat(input.value);
                let coef = parseInt(input.getAttribute('data-coef'));
                
                if (!isNaN(val)) {
                    if (val > 20) val = 20; 
                    if (val < 0) val = 0;
                    totalPoints += val * coef;
                }
                totalCoef += coef;
            });

            const average = totalCoef > 0 ? (totalPoints / totalCoef).toFixed(4) : "00.00";
            
            document.getElementById('simResult').innerText = parseFloat(average).toFixed(2);
            document.getElementById('simTotalPoints').innerText = totalPoints.toFixed(2);
            document.getElementById('simTotalCoef').innerText = totalCoef;
            
            const resultEl = document.getElementById('simResult');
            if(parseFloat(average) >= 10) {
                resultEl.style.color = '#fff';
                resultEl.parentElement.style.background = 'linear-gradient(135deg, var(--primary), #25D366)';
            } else {
                resultEl.style.color = '#ffeb3b';
                resultEl.parentElement.style.background = 'linear-gradient(135deg, var(--secondary), var(--primary))';
            }
        }
    </script>
</body>
</html>